<!--
  The common.js file must be included before this file.

  This in an HTML Import-able file that contains the definition
  of the following elements:

    <comments-sk>

  To use this file import it:

    <link href="/res/imp/comments-sk.html" rel="import" />

  Usage:

    <comments-sk
        comments="{{myComments}}"
        addCommentUrl="/json/comments">
    </comments-sk>

  Properties:
    collapsed: Bool indicating whether all comments are shown, or if some are
        hidden behind a "view more" link.
    collapseThreshold: Number indicating the maximum number of comments to show
        when collapsed.
    comments: Array of comment objects, with attributes 'time', 'user', and
        'message'.
    addCommentUrl: URL which accepts POST requests for adding comments.
    allowEmptyComments: Whether or not to allow empty comments.
    allowDelete: Whether or not to allow deletion of comments.

  Methods:
    collapse: Hides comments when there are more than `collapseThreshold`
    uncollapse: Shows all comments.

  Events:
    submit: When a comment is added, the 'submit' event is triggered. New
        comments do not appear in the list because it is not possible to
        guarantee consistency between the UI and the database until the comment
        has been inserted. Therefore, the 'submit' event may be used to reload
        the comments from the database.
-->
<polymer-element name="comments-sk">
  <template>
    <style>
    .viewlink {
      font-size: 0.7em;
    }
    td {
      padding: 5px;
    }
    </style>
    <table>
      <template if="{{collapsed && comments.length > collapseThreshold}}">
        <td colspan="3" class="viewlink">
          <a href="#" onClick="return false;" on-click="{{uncollapse}}">... view {{comments.length - collapseThreshold}} more comments</a>
        </td>
      </template>
      <template if="{{!collapsed && comments.length > collapseThreshold}}">
        <td colspan="3" class="viewlink">
          <a href="#" onClick="return false;" on-click="{{collapse}}">... view fewer comments</a>
        </td>
      </template>
      <template repeat="{{comment, index in comments}}">
        <template if="{{!collapsed || index >= comments.length - collapseThreshold}}">
          <tr class="comment">
            <template if="{{comment.time && comment.user && comment.message}}">
              <td class="commentCell">{{comment.time|parseDate}}</td>
              <td class="commentCell">{{comment.user}}</td>
              <td class="commentCell">{{comment.message}}</td>
              <template if="{{editRights && allowDelete}}">
                <td class="commentCell">
                  <core-icon-button icon="clear" x-data="{{comment.id}}" on-click="{{deleteComment}}"></core-icon-button>
                </td>
              </template>
            </template>
          </tr>
        </template>
      </template>
    </table>
    <content id="content"></content>
    <template if="{{editRights}}">
      <div horizontal layout>
        <paper-input id="commentBox" label="comment" value="{{commentText}}" flex></paper-input>
        <paper-button on-click="{{addComment}}">submit</paper-button>
      </div>
    </template>
    <paper-toast id="actionFailed" text="Action Failed"></paper-toast>
  </template>
  <script>
    Polymer({
      publish: {
        collapsed: {
          value: true,
          reflect: true,
        },
        collapseThreshold: {
          value: 3,
          reflect: true,
        },
        comments: {
          value: [],
          reflect: true,
        },
        commentText: {
          value: "",
          reflect: true,
        },
        addCommentUrl: {
          value: "/comments/add",
          reflect: true,
        },
        allowDelete: {
          value: false,
          reflect: true,
        },
        allowEmptyComments: {
          value: false,
          reflect: true,
        },
      },

      ready: function() {
        var ele = this;
        sk.Login.then(function(status) {
          var email = status['Email'];
          var validEmail = "@google.com"
          if (email.indexOf(validEmail, email.length - validEmail.length) !== -1) {
            ele.editRights = true;
          }
        });
      },

      collapse: function() {
        this.collapsed = true;
      },

      uncollapse: function() {
        this.collapsed = false;
      },

      domReady: function() {
        this.linkifyComments();
      },

      linkifyComments: function() {
        var commentBoxes = this.shadowRoot.querySelectorAll("div.commentCell");
        if (!commentBoxes || commentBoxes.length == 0) {
          return;
        }
        for (var i = 0; i < commentBoxes.length; i++) {
          var c = commentBoxes[i];
          var msg = c.getAttribute("message");
          if (!msg) {
            continue;
          }
          c.innerHTML = sk.formatHTML(msg, true);
        }
      },

      showErrorDialog: function(msg) {
        var errorDiag = this.$.actionFailed;
        errorDiag.text = msg;
        errorDiag.show();
      },

      parseDate: function(v) {
        var d = new Date(v * 1000)
        return d.toLocaleDateString() + ", " + d.toLocaleTimeString();
      },

      addComment: function() {
        if (!this.allowEmptyComments && this.commentText == "") {
          this.showErrorDialog("Empty comments are not allowed.");
          return;
        }

        var params = {};
        for (var i = 0; i < this.children.length; i++) {
          var child = this.children[i];
          if (child.id) {
            if (child.value != undefined) {
              params[child.id] = child.value;
            } else if (child.checked != undefined) {
              params[child.id] = child.checked ? true : false;
            }
          }
        }
        params["comment"] = this.commentText;

        var that = this;
        sk.post(this.addCommentUrl, JSON.stringify(params)).then(function(resp) {
          that.dispatchEvent(new CustomEvent("submit", null));
        }, function(err) {
          that.showErrorDialog(err);
        });
        this.shadowRoot.querySelector("#commentBox").value = "";
      },

      deleteComment: function(e, d, t) {
        var commentId = t.getAttribute("x-data");
        var that = this;
        sk.delete(this.addCommentUrl + "/" + commentId).then(function(resp) {
          that.dispatchEvent(new CustomEvent("submit", null));
        }, function(err) {
          that.showErrorDialog(err);
        });
      },
    });
  </script>
</polymer-element>
