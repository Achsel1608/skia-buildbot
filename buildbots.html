<html>
  <head>
    <title>
      Skia Buildbot
    </title>
    <link rel="icon" href="favicon.ico">
    <link rel="stylesheet" href="master/public_html/default.css"
        type="text/css">
    <script type="text/javascript" src="skia_tools.js"></script>
    <script language="JavaScript">
    "use strict";

    var nonbench_percommit_builders = [];
    var bench_percommit_builders = [];
    var all_percommit_builders = [];
    var try_builders = [];

    var display_builders = "nonbench";
    var display_builders_list = nonbench_percommit_builders;
    var display_view = "external";
    var display_page = "console";
    var internalport = skiaTools.getVariable("internal_port");
    var externalport = skiaTools.getVariable("external_port");
    var port = externalport;
    var host = "http://" + skiaTools.getVariable("master_host");
    var skia_repo = skiaTools.getVariable("skia_svn_url");
    var try_repo = skiaTools.getVariable("try_svn_url");
    var display_repo = skia_repo;

    // Return a string of the form: "&builder=x&builder=y..." with all of those
    // contained in the given array of builders.
    function getBuilderString(builders) {
      var builder_string = "";
      for (var i = 0; i < builders.length; i++) {
        builder_string = builder_string.concat("&builder=", builders[i]);
      }
      return builder_string;
    }

    // Reload the buildbot console page in the iframe with whatever options we
    // have set.
    function updateView() {
      port = externalport;
      document.all.external.checked = true;
      if (display_view == "internal") {
        port = internalport;
        document.all.internal.checked = true;
      }
      var url = host + ":" + port + "/" + display_page +
                "?reload=40&repository=" + display_repo +
                getBuilderString(display_builders_list);
      document.all.content.src = url;
      var id = display_builders;
      document.getElementById(id).checked = true;
    }

    // Parse the variables in the URL and return a key/value dictionary.
    function parseArgs()
    {
      var args = [];
      var dict = window.location.search.slice(1).split('&');
      for(var i = 0; i < dict.length; i++) {
        var split = dict[i].split('=');
        args.push(split[0]);
        args[split[0]] = split[1];
      }
      
      return args;
    }

    // Reload this page, setting the given variables in the URL.
    function reloadWithOptions(view, builders, page) {
      location.href = "?view=" + view + "&builders=" + builders + "&page=" +
          page;
    }

    // Obtain the list of all builders from the buildbot master and load them
    // into the global arrays of builders.
    function getBuilderLists() {
      var builders = skiaTools.loadBuilders();
      nonbench_percommit_builders = [];
      bench_percommit_builders = [];
      all_percommit_builders = [];
      try_builders = [];
      for (var i = 0; i < builders.length; ++i) {
        var builder = builders[i].name;
        if (builder.indexOf("Trybot") != -1) {
          try_builders.push(builder)
        } else {
          all_percommit_builders.push(builder);
          if (builder.indexOf("Bench") != -1) {
            bench_percommit_builders.push(builder);
          } else {
            nonbench_percommit_builders.push(builder);
          }
        }
      }
    }

    function loadMenuLinks() {
      var links = [
        ["https://sites.google.com/site/skiadocs/developer-documentation/the-skia-buildbots/1-overview", "Full Skia documentation"],
        ["https://skia-tree-status.appspot.com/", "Skia Tree Status Manager"],
        ["https://code.google.com/p/skia/issues/list?can=2&q=label%3ABreakingTheBuildbots", "Current build-breaking bugs"],
        ["bench_graphs.html", "Bench Graphs"],
        ["http://go/skpbench", "Bench Dashboard"],
        ["bug_graphs.html", "Open Bugs Graph"]
      ];
      var links_div = document.getElementById("links");
      var html = "";
      for (var i = 0; i < links.length; ++i) {
        var link = links[i];
        html += '<div style="float:left; width: 190px;">';
        html += '<ul style="margin: 0px 0px 0px 25px; padding:0;">';
        html += '<li><a href="' + link[0] + '" target="_blank">' + link[1] +
            '</a><br/></li>';
        html += '</ul></div>';
      }
      links_div.innerHTML = html;
    }

    // Function to call on page load.  Sets all global variables and updates the
    // iframe view of the buildbot page.
    function init() {
      loadMenuLinks();
      getBuilderLists();
      var args = parseArgs();
      display_builders = args["builders"];
      if (!display_builders) {
        display_builders = "nonbench";
      }
      if (display_builders == "bench") {
        display_builders_list = bench_percommit_builders;
        display_repo = skia_repo;
      } else if (display_builders == "all") {
        display_builders_list = all_percommit_builders;
        display_repo = skia_repo;
      } else if (display_builders == "try") {
        display_builders_list = try_builders;
        display_repo = try_repo;
      } else {
        display_builders = "nonbench";
        display_builders_list = nonbench_percommit_builders;
        display_repo = skia_repo;
      }
      display_view = args["view"];
      if (!display_view)
        display_view = "external";
      display_page = args["page"];
      if (!display_page)
        display_page = "console";
      if (display_page == "home")
        display_page = "";
      updateView();
    }

    function resizeIframe(width, height) {
      console.log("resizing iframe!!!");
      var padding = 32;
      document.all.content.style.width = (width + padding) + "px";
      document.all.content.style.height = (height + padding) + "px";
    }

    function reloadSkiaTreeStatus() {
      document.getElementById("skia-tree-status").src =
          document.getElementById("skia-tree-status").src;
    }

    window.setInterval("reloadSkiaTreeStatus();", 10000);
    </script>

  </head>
  <body class="interface" onload="init()" style="background: url(master/public_html/bg_gradient.jpg) repeat-x; background-size: 20px 300px;" allowTransparency="true">
    <iframe id="skia-tree-status" width="100%" height="40" frameborder="0" scrolling="no" src="http://skia-tree-status.appspot.com/banner-status"></iframe>
    <div id="container" style="float: left; width: 100%; min-height: 65px;">
      <div style="float:left; width:30%; position: relative; z-index:2;">
      <form name="unused">
        <input type="radio" name="internal_external" value="external" id="external" onClick="reloadWithOptions('external', display_builders, display_page);">External View<br>
        <input type="radio" name="internal_external" value="internal" id="internal" onClick="reloadWithOptions('internal', display_builders, display_page);">Internal View
      </form>
      </div>

      <div id="links" style="float:right; max-width:22%; position: relative; z-index:2;"></div>

      <div style="text-align:center; position: absolute; width: 100%; height: 65px; z-index:1;">
        <div id="heading" style="font-size:3.5em; text-align:center;">Skia Buildbots</div>
        <div style="text-align:center;">
          <form name="unused2">
            <nobr>
            <input type="radio" id="nonbench" value="nonbench" onClick="javascript:reloadWithOptions(display_view, 'nonbench', display_page);">Non-Bench Builders
            <input type="radio" id="bench" value="bench" onClick="javascript:reloadWithOptions(display_view, 'bench', display_page);">Bench Builders
            <input type="radio" id="all" value="all" onClick="javascript:reloadWithOptions(display_view, 'all', display_page);">All Builders
            <input type="radio" id="try" value="try" onClick="javascript:reloadWithOptions(display_view, 'try', display_page);">Trybots
            </nobr>
          </form>
        </div>
      </div>  
    </div>
    <div width="100%" style="text-align: center; padding: 8px 0px;">
        <!-- TODO(borenet): Make this work with "open new tab."  -->
        <a href="javascript:;" onClick="javascript:reloadWithOptions(display_view, display_builders, 'home');">Home</a> -
        <a href="javascript:;" onClick="javascript:reloadWithOptions(display_view, display_builders, 'waterfall');">Waterfall</a>
        <a href="javascript:;" onClick="javascript:reloadWithOptions(display_view, display_builders, 'grid');">Grid</a>
        <a href="javascript:;" onClick="javascript:reloadWithOptions(display_view, display_builders, 'tgrid');">T-Grid</a>
        <a href="javascript:;" onClick="javascript:reloadWithOptions(display_view, display_builders, 'console');">Console</a>
        <a href="javascript:;" onClick="javascript:reloadWithOptions(display_view, display_builders, 'builders');">Builders</a>
        <a href="javascript:;" onClick="javascript:reloadWithOptions(display_view, display_builders, 'one_line_per_build');">Recent Builds</a>
        <a href="javascript:;" onClick="javascript:reloadWithOptions(display_view, display_builders, 'buildslaves');">Buildslaves</a>
        <a href="javascript:;" onClick="javascript:reloadWithOptions(display_view, display_builders, 'changes');">Changesources</a> -
        <a href="javascript:;" onClick="javascript:reloadWithOptions(display_view, display_builders, 'json/help');">JSON API</a> -
        <a href="javascript:;" onClick="javascript:reloadWithOptions(display_view, display_builders, 'about');">About</a>
    </div>
    <iframe id="content" width="100%" height="4650px" src="about:blank" frameborder="0"></iframe>

  </body>
</html>
