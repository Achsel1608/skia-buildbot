<!--
  This in an HTML Import-able file that contains the definition
  of the following elements:

    <job-sk>

  Status information about the task scheduler.

  To use this file import it:

    <link href="/res/imp/job-sk.html" rel="import" />

  Usage:

    <job-sk></job-sk>

  Properties:
    // input
    job: Object representing a job.
    tasks: Object whose keys are task spec names and values are tasks.
    depGraph: Object whose keys are task spec names and values are arrays of
        task spec names indicating which task specs depend upon which other
        task specs.

  Methods:
    None.

  Events:
    None.
-->

<link rel="import" href="/res/common/imp/human-date-sk.html">

<dom-module id="job-sk">
  <template>
    <style>
    :host {
      font-family: sans-serif;
    }
    .table {
      border-collapse: collapse;
      display: table;
    }
    .tr {
      border-bottom: 1px solid #EEEEEE;
      display: table-row;
    }
    .tr:hover {
      background-color: #F5F5F5;
    }
    .tr:hover .tr:hover {
      background-color: #FFFFFF;
    }
    .td,.th {
      display: table-cell;
      padding: 10px;
    }
    .td {
      color: #212121;
      font-size: 0.813em;
      vertical-align: middle;
    }
    .th {
      color: #767676;
      font-size: 0.75em;
    }
    </style>
    <h2>Job <span>[[job.Name]]</span></h2>
    <div class="table">
      <div class="tr"><div class="td">ID</div><div class="td">[[job.Id]]</div></div>
      <div class="tr"><div class="td">Name</div><div class="td">[[job.Name]]</div></div>
      <div class="tr">
        <div class="td">Status</div>
        <div class="td" style$="background-color:[[_statusColor]]">[[_statusText]]</div>
      </div>
      <div class="tr">
        <div class="td">Repo</div>
        <div class="td"><a href$="[[job.Repo]]" target="_blank">[[job.Repo]]</a></div>
      </div>
      <div class="tr">
        <div class="td">Revision</div>
        <div class="td"><a href$="[[_revisionLink]]" target="_blank">[[job.Revision]]</a></div>
      </div>
      <template is="dom-if" if="[[_isTryJob]]">
        <div class="tr">
          <div class="td">Codereview Link</div>
          <div class="td"><a href$="[[_codereviewLink]]" target="_blank">[[_codereviewLink]]</a></div>
        </div>
        <div class="tr"><div class="td">Codereview Server</div><div class="td">[[job.Server]]</div></div>
        <div class="tr"><div class="td">Issue</div><div class="td">[[job.Issue]]</div></div>
        <div class="tr"><div class="td">Patchset</div><div class="td">[[job.Patchset]]</div></div>
      </template>
      <div class="tr"><div class="td">Created</div><div class="td"><human-date-sk date="[[job.Created]]"></human-date-sk></div></div>
      <template is="dom-if" if="[[job.Status]]">
        <div class="tr"><div class="td">Finished</div><div class="td"><human-date-sk date="[[job.Finished]]"></human-date-sk></div></div>
      </template>
      <div class="tr"><div class="td">Manually forced</div><div class="td">[[job.IsForce]]</div></div>
    </div>

  <!-- TODO(borenet): Add a pretty display of the task dependency graph for the job. -->

  </template>
  <script>
  (function(){
    var jobStatusToTextColor = {
      "":         ["in progress", "rgb(248, 230, 180)"],
      "SUCCESS":  ["succeeded",   "rgb(209, 228, 188)"],
      "FAILURE":  ["failed",      "rgb(217, 95, 2)"],
      "MISHAP":   ["mishap",      "rgb(117, 112, 179)"],
      "CANCELED": ["canceled",    "rgb(117, 112, 179)"],
    };

    Polymer({
      is: "job-sk",

      properties: {
        job: {
          type: Object,
          value: function() {
            return {};
          },
        },

        tasks: {
          type: Object,
          value: function() {
            return {};
          },
        },

        depGraph: {
          type: Object,
          value: function() {
            return {};
          },
        },

        _isTryJob: {
          type: Boolean,
          computed: "_computeIsTryJob(job)",
        },
        _revisionLink: {
          type: String,
          computed: "_computeRevisionLink(job)",
        },
        _codereviewLink: {
          type: String,
          computed: "_computeCodereviewLink(job)",
        },
        _statusText: {
          type: String,
          computed: "_computeStatusText(job)",
        },
        _statusColor: {
          type: String,
          computed: "_computeStatusColor(job)",
        },
      },

      _computeIsTryJob: function(job) {
        return job.Server != "" && job.Issue != "" && job.Patchset != "";
      },

      _computeRevisionLink: function(job) {
        // This assumes we use Gitiles, but that's a safe assumption for now.
        return job.Repo + "/+/" + job.Revision;
      },

      _computeCodereviewLink: function(job) {
        if (job.Server.indexOf("codereview.chromium") != -1) {
          return job.Server + "/" + job.Issue + "/#ps" + job.Patchset;
        } else {
          return job.Server + "/c/" + job.Issue + "/" + job.Patchset;
        }
      },

      _computeStatusText: function(job) {
        return jobStatusToTextColor[job.Status][0];
      },

      _computeStatusColor: function(job) {
        return jobStatusToTextColor[job.Status][1];
      },
    });
  })();
  </script>
</dom-module>
