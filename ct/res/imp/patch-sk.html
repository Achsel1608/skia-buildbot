<!--
  The <patch-sk> custom element declaration. Allows entering a CL in the form of
  https://codereview.chromium.org/1344993003 (or just the CL number) to retrieve a patch from that
  CL. Alternatively, allows entering a patch manually in an expanding text area.

  Attributes:
    patchType: Specifies the project for the patch. Must be set. Supported values include
      "chromium", "blink", and "skia". See also encodeCLData in
      ct/go/ctfe/chromium_perf/chromium_perf.go.
    cl: Raw value of the CL input. Does not notify.
    clDescription: Human-readable description of the CL. Notifies.
    patch: The patch, either retrieved from the CL or manually entered/modified. Notifies.

  Events:
    None.

  Methods:
    validate(): Checks that patch is valid based on cl. If not, shows an error toast and returns
      false. Otherwise returns true.
-->

<dom-module id="patch-sk">
  <style>
    paper-input {
      width: 20em;
    }

    .long-field {
      width: 40em;
    }

    td.cl-label {
      vertical-align: middle;
    }

    .cl-detail-container {
      position: relative;
      text-align: center;
      height: 100px;
      min-width: 200px;
      max-width: 300px;
    }

    .loading-cl-spinner {
      margin: auto;
      vertical-align: middle;
    }

    .cl-detail {
      position: absolute;
      top: 0px;
      left: 0px;
      text-align: start;
    }

    .cl-error {
      color: red;
    }
  </style>
  <template>
    <table>
      <tr>
        <td class="cl-label">CL:</td>
        <td>
          <paper-input value="{{cl}}" maxlength="60"></paper-input>
          <a href="javascript:void(0);" id="patch_expander">
            <iron-icon icon="{{patchExpanderIcon(patchOpened)}}"></iron-icon>
            Specify patch manually</a>
        </td>
        <td>
          <div class="cl-detail-container">
            <div class="loading-cl-spinner">
              <paper-spinner active="{{loadingClDetail}}"
                             alt="Loading CL details"></paper-spinner>
            </div>
            <div class="cl-detail">
              <a href$="{{clUrl(clData)}}" target="_blank">{{formatClData(clData)}}</a>
              <span class="cl-error">{{formatClError(clData)}}</span>
            </div>
        </td>
      </tr>
      <tr>
        <td colspan="3">
          <div class="long-field">
           <iron-collapse id="patch_collapse" opened="{{patchOpened}}">
             <iron-autogrow-textarea class="long-field" rows=5 max-rows=20 bind-value="{{patch}}">
             </iron-autogrow-textarea>
           </iron-collapse>
          </div>
        </td>
      </tr>
    </table>
  </template>
  <script>
    Polymer({
      is: "patch-sk",
      properties: {
        patchType: String,
        cl: {
          type: String,
          value: "",
          observer: "clChanged",
        },
        clData: Object,
        loadingClDetail: {
          type: Boolean,
          value: false,
        },
        clDescription: {
          type: String,
          computed: "formatClDescription(clData)",
          notify: true,
        },
        patchOpened: {
          type: Boolean,
          value: false,
        },
        patch: {
          type: String,
          notify: true,
        },
      },

      ready: function() {
        var that = this;
        this.$.patch_expander.addEventListener('click', function(e) {
          that.$.patch_collapse.toggle();
        });
      },

      clChanged: function(newValue) {
        if (!newValue || newValue.length < 3) {
          this.clData = null;
          this.loadingClDetail = false;
          return;
        }
        this.loadingClDetail = true;
        var params = {cl: newValue};
        sk.post("/_/cl_data?" + sk.query.fromObject(params)).then(JSON.parse).then(function (json) {
          if (this.cl == newValue) {
            if (json.cl) {
              this.clData = json;
              var patch = this.clData[this.patchType + "_patch"];
              if (!patch) {
                this.clData = {error: "This is not a " + this.patchType + " CL."};
              } else {
                this.patch = patch;
              }
            } else {
              this.clData = null;
            }
            this.loadingClDetail = false;
          }
        }.bind(this)).catch(function (err) {
          if (this.cl == newValue) {
            this.clData = {error: err};
            this.loadingClDetail = false;
          }
        }.bind(this));
      },

      clUrl: function(clData) {
        if (clData && !clData.error) {
          return "https://codereview.chromium.org/" + clData.cl + "/#ps" + clData.patchset;
        }
        return "javascript:void(0);"
      },

      formatClData: function(clData) {
        if (clData && !clData.error) {
          return clData.subject +
              " (modified " + ctfe.getFormattedTimestamp(clData.modified) + ")";
        }
        return "";
      },

      formatClError: function(clData) {
        if (clData && clData.error) {
          return clData.error
        }
        return "";
      },

      formatClDescription: function(clData) {
        if (clData && !clData.error) {
          return this.clUrl(clData) + " (" + clData.subject + ")";
        }
        return ""
      },

      patchExpanderIcon: function(patchOpened) {
        if (patchOpened) {
          return "expand-less";
        } else {
          return "expand-more";
        }
      },

      validate: function() {
        if (this.cl && !this.clData) {
          sk.errorMessage("Unable to load " + this.patchType + " CL " + this.cl +
                          ". Please specify patches manually.");
          return false;
        }
        if (this.cl && !this.patch) {
          sk.errorMessage("Unable to fetch " + this.patchType + " patch from CL " + this.cl +
                          ". Please specify patches manually.");
          return false;
        }
        return true;
      },
    });
  </script>

</dom-module>

<dom-module id="chromium-perf-sk">
  <style>
    paper-input {
      width: 20em;
    }

    .iron-selected {
      background-color: #D6ECF2;
    }

    .long-field {
      width: 40em;
    }

    .short-field {
      width: 5em;
    }

    iron-selector.medium-field > div {
      width: 20em;
    }

    iron-selector.short-field > div {
      width: 5em;
    }

    table.options td {
      padding: 1em 2em;
    }

    td.center {
      text-align:center;
      padding-top:2em;
    }

    .panel {
      @apply(--shadow-elevation-2dp);
    }
  </style>
  <template>

    <paper-dialog heading="Confirmation" id="confirm_dialog">
      <div>Proceed with queueing task?</div>
      <paper-button id="task_dismiss">Cancel</paper-button>
      <paper-button id="task_confirm" autofocus>OK</paper-button>
    </paper-dialog>

    <table class="options panel">
      <tr>
        <td>Benchmark Name</td>
        <td>
          <iron-selector attr-for-selected="id" id="benchmark_name" selected="rasterize_and_record_micro" class="medium-field">
            <template is="dom-repeat" items="{{benchmarks}}">
              <div id="{{item}}">{{item}}</div>
            </template>
          </iron-selector>
        </td>
      </tr>

      <tr>
        <td>Target Platform</td>
        <td>
          <iron-selector attr-for-selected="id" id="target_platform" selected="Linux" class="medium-field">
            <template is="dom-repeat" items="{{platforms}}">
              <div id="{{item}}">{{getPlatformDesc(item)}}</div>
            </template>
          </iron-selector>
        </td>
      </tr>

      <tr>
        <td>PageSets Type</td>
        <td>
          <page-set-selector-sk id="page_sets" page-sets="{{pageSets}}"></page-set-selector-sk>
        </td>
      </tr>

      <tr>
        <td>Repeat each page</td>
        <td>
          <iron-selector attr-for-selected="id" id="repeat_runs" selected="3" class="short-field">
            <div id="3">3</div>
            <div id="2">2</div>
            <div id="1">1</div>
          </iron-selector>
        </td>
      </tr>

      <tr>
        <td>Benchmark Arguments</td>
        <td>
          <paper-input value="--output-format=csv-pivot-table" id="benchmark_args"></paper-input>
        </td>
      </tr>

      <tr>
        <td>Browser Arguments (nopatch run)</td>
        <td>
          <paper-input value="" id="browser_args_nopatch" class="long-field"></paper-input>
        </td>
      </tr>

      <tr>
        <td>Browser Arguments (withpatch run)</td>
        <td>
          <paper-input value="" id="browser_args_withpatch" class="long-field"></paper-input>
        </td>
      </tr>

      <tr>
        <td>
          Chromium Git patch (optional)<br/>
          Applied to Chromium ToT
        </td>
        <td>
          <chromium-perf-patch-sk id="chromium_patch"
                                  patch-type="chromium"
                                  cl-description="{{chromiumClDescription}}">
          </chromium-perf-patch-sk>
        </td>
      </tr>

      <tr>
        <td>
          Blink Git patch (optional)<br/>
          Applied to Blink Rev in <a href="http://src.chromium.org/viewvc/chrome/trunk/src/DEPS">DEPS</a>
        </td>
        <td>
          <chromium-perf-patch-sk id="blink_patch"
                                  patch-type="blink"
                                  cl-description="{{blinkClDescription}}">
          </chromium-perf-patch-sk>
        </td>
      </tr>

      <tr>
        <td>
          Skia Git patch (optional)<br/>
          Applied to Skia Rev in <a href="http://src.chromium.org/viewvc/chrome/trunk/src/DEPS">DEPS</a>
        </td>
        <td>
          <chromium-perf-patch-sk id="skia_patch"
                                  patch-type="skia"
                                  cl-description="{{skiaClDescription}}">
          </chromium-perf-patch-sk>
        </td>
      </tr>

      <tr>
        <td>Repeat this task</td>
        <td>
          <repeat-after-days-sk id="repeat_after_days"></repeat-after-days-sk>
        </td>
      </tr>

      <tr>
        <td>Description</td>
        <td>
          <paper-input value="" id="desc" label="Description is required"></paper-input>
        </td>
      </tr>

      <tr>
        <td colspan="2" class="center">
          <paper-button raised id="submit_task">Queue Task</paper-button>
        </td>
      </tr>
      <tr>
        <td colspan="2" class="center">
          <paper-button raised id="view_history">View runs history</paper-button>
        </td>
      </tr>
    </table>

    <br/><br/>

  </template>
</dom-module>

<script>
   Polymer({
     is: "chromium-perf-sk",
     properties: {
       benchmarks: {
         type: Array,
         value: [],
       },
       platforms: {
         type: Array,
         value: [],
       },
       platformsToDesc: {
         type: Object,
         value: {},
       },
       pageSets: {
         type: Array,
         observer: 'pageSetsChanged',
       },
       defaultLinuxBrowserArgs: {
         type: String,
         value: "--disable-setuid-sandbox --enable-threaded-compositing --enable-impl-side-painting",
       },
       chromiumClDescription: String,
       blinkClDescription: String,
       skiaClDescription: String,
     },

     observers: [
       "clDescriptionChanged(chromiumClDescription, blinkClDescription, skiaClDescription)"
     ],

     ready: function() {
       var that = this;
       this.$.target_platform.addEventListener('click', function(e) {
         that.platformChanged();
       });
       this.$.submit_task.addEventListener('click', function(e) {
         that.validateTask();
       });
       this.$.task_dismiss.addEventListener('click', function(e) {
         that.dismissTask();
       });
       this.$.task_confirm.addEventListener('click', function(e) {
         that.queueTask();
       });
       this.$.view_history.addEventListener('click', function(e) {
         that.gotoRunsHistory();
       });
       this.platformChanged();
     },

     getPlatformDesc: function(platform) {
       if (this.platformsToDesc) {
         return this.platformsToDesc[platform];
       }
     },

     pageSetsChanged: function(newValue, oldValue) {
       // CT's chromium perf does not support 1M.
       for (var i=0; i<this.pageSets.length; i++) {
         if (ctfe.pageSets.getKey(this.pageSets[i]) == "All") {
           this.pageSets.splice(i, 1);
           break;
         }
       }
       if (!oldValue || oldValue.length == 0) {
         this.$.page_sets.selectFirst();
       }
     },

     platformChanged: function() {
       if (this.$.target_platform.selected == "Linux") {
         this.$.page_sets.selected = "10k";
         this.$.browser_args_nopatch.value = this.defaultLinuxBrowserArgs;
         this.$.browser_args_withpatch.value = this.defaultLinuxBrowserArgs;
       } else {
         this.$.page_sets.selected = "Mobile10k";
         this.$.browser_args_nopatch.value = "";
         this.$.browser_args_withpatch.value = "";
       }
     },

     clDescriptionChanged: function(chromiumClDescription, blinkClDescription, skiaClDescription) {
       if (!chromiumClDescription && !blinkClDescription && !skiaClDescription) {
         this.$.desc.value = "";
       } else {
         var str = "Testing ";
         var prev = false;
         if (chromiumClDescription) {
           str += chromiumClDescription;
           prev = true;
         }
         if (blinkClDescription) {
           if (prev) {
             str += " and ";
           }
           str += blinkClDescription;
           prev = true;
         }
         if (skiaClDescription) {
           if (prev) {
             str += " and ";
           }
           str += skiaClDescription;
           prev = true;
         }
         this.$.desc.value = str;
       }
     },

     validateTask: function() {
       if (!this.$.chromium_patch.validate() ||
           !this.$.blink_patch.validate() ||
           !this.$.skia_patch.validate()) {
         return;
       }
       if (! this.$.desc.value) {
         sk.errorMessage("Please specify a description");
         this.$.desc.focus();
         return;
       }
       this.$.confirm_dialog.open()
     },

     dismissTask: function() {
       sk.errorMessage("Did not queue");
       this.$.confirm_dialog.close()
     },

     queueTask: function() {
       var params = {};
       params["benchmark"] = this.$.benchmark_name.selected;
       params["platform"] = this.$.target_platform.selected;
       params["page_sets"] = this.$.page_sets.selected;
       params["repeat_runs"] = this.$.repeat_runs.selected;
       params["benchmark_args"] = this.$.benchmark_args.value;
       params["browser_args_nopatch"] = this.$.browser_args_nopatch.value;
       params["browser_args_withpatch"] = this.$.browser_args_withpatch.value;
       params["desc"] = this.$.desc.value;
       params["chromium_patch"] = this.$.chromium_patch.patch;
       params["blink_patch"] = this.$.blink_patch.patch;
       params["skia_patch"] = this.$.skia_patch.patch;
       params["repeat_after_days"] = this.$.repeat_after_days.selected;

       var that = this;
       sk.post("/_/add_chromium_perf_task", JSON.stringify(params)).then(function(resp) {
         that.gotoRunsHistory();
       }).catch(sk.errorMessage);
     },

     gotoRunsHistory: function() {
       window.location.href = "/chromium_perf_runs/";
     },
   });
</script>
