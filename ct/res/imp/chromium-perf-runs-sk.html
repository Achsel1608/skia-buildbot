<!--
  This in an HTML Import-able file that contains the definition
  of the following elements:

    <chromium-perf-runs-sk>

  To use this file import it:

    <link href="/res/imp/chromium-perf-runs-sk.html" rel="import" />

  Usage:

    <chromium-perf-runs-sk></chromium-perf-runs-sk>
-->

<dom-module id="chromium-perf-runs-sk">
  <style>
    paper-dialog {
      min-width: 200px;
    }
    table.runshistory {
      border-spacing: 0px;
    }
    tr.headers {
      background-color: #CCCCFF;
      text-align: center;
    }
    td.nowrap {
      white-space: nowrap;
    }
    table.runshistory > tbody > tr > td {
      padding: 10px;
      border: solid black 1px;
    }
  </style>
  <template>

    <h2><template is="dom-if" if="{{constrainByUser}}">My </template>Chromium Perf Runs</h2>
    <paging-sk pagination="{{pagination}}" on-pagechange="pageChangedHandler"></paging-sk>
    <br/>
    <paper-button raised id="constrain_runs" on-click="constrainRuns">{{constrainButtonText}}</paper-button>

    <br/>
    <br/>

    <!-- Section for popups. -->
    <template is="dom-repeat" items="{{chromiumPerfTasks}}" as="chromiumPerfTask" index-as="index">
      <paper-dialog heading="Benchmark Args" id="{{ getBenchmarkArgsId(index) }}">
        <paper-dialog-scrollable>
          <pre>{{chromiumPerfTask.BenchmarkArgs}}</pre>
        </paper-dialog-scrollable>
      </paper-dialog>

      <paper-dialog heading="Browser Args NoPatch" id="{{ getBrowserArgsNoPatchId(index) }}">
        <paper-dialog-scrollable>
          <pre>{{chromiumPerfTask.BrowserArgsNoPatch}}</pre>
        </paper-dialog-scrollable>
      </paper-dialog>

      <paper-dialog heading="Browser Args WithPatch" id="{{ getBrowserArgsWithPatchId(index) }}">
        <paper-dialog-scrollable>
          <pre>{{chromiumPerfTask.BrowserArgsWithPatch}}</pre>
        </paper-dialog-scrollable>
      </paper-dialog>

      <paper-dialog heading="Chromium Patch" id="{{ getChromiumPatchId(index) }}">
        <paper-dialog-scrollable>
          <pre>{{chromiumPerfTask.ChromiumPatch}}</pre>
        </paper-dialog-scrollable>
      </paper-dialog>

      <paper-dialog heading="Blink Patch" id="{{ getBlinkPatchId(index) }}">
        <paper-dialog-scrollable>
          <pre>{{chromiumPerfTask.BlinkPatch}}</pre>
        </paper-dialog-scrollable>
      </paper-dialog>

      <paper-dialog heading="Skia Patch" id="{{ getSkiaPatchId(index) }}">
        <paper-dialog-scrollable>
          <pre>{{chromiumPerfTask.SkiaPatch}}</pre>
        </paper-dialog-scrollable>
      </paper-dialog>
    </template>

    <table class="runshistory" id="runshistory" cellpadding="5" border="1">
      <tr class="headers">
        <td>Id</td>
        <td>User</td>
        <td>Timestamps</td>
        <td>Task Config</td>
        <td>Description</td>
        <td>Results</td>
        <td>Arguments</td>
        <td>Patches</td>
      </tr>

      <template is="dom-repeat" items="{{chromiumPerfTasks}}" as="chromiumPerfTask" index-as="index">
      <tr style="border: 1px solid black;">
        <!-- Id col --> 
        <td>{{chromiumPerfTask.Id}}</td>

        <!-- User col --> 
        <td>{{chromiumPerfTask.Username}}</td>

        <!-- Timestamps col --> 
        <td>
          <table>
            <tr>
              <td>Added:</td>
              <td class="nowrap">{{ formatTimestamp(chromiumPerfTask.TsAdded.Int64) }}</td>
            </tr>
            <tr>
              <td>Started:</td>
              <td class="nowrap">{{ formatTimestamp(chromiumPerfTask.TsStarted.Int64) }}</td>
            </tr>
            <tr>
              <td>Completed:</td>
              <td class="nowrap">{{ formatTimestamp(chromiumPerfTask.TsCompleted.Int64) }}</td>
            </tr>
          </table>
        </td>

        <!-- Task Config col --> 
        <td>
          <table>
            <tr>
              <td>Benchmark:</td>
              <td>{{chromiumPerfTask.Benchmark}}</td>
            </tr>
            <tr>
              <td>Platform:</td>
              <td>{{chromiumPerfTask.Platform}}</td>
            </tr>
            <tr>
              <td>PageSet:</td>
              <td>{{chromiumPerfTask.PageSets}}</td>
            </tr>
            <tr>
              <td>Repeats:</td>
              <td>{{chromiumPerfTask.RepeatRuns}}</td>
            </tr>
          </table>
        </td>

        <!-- Description col --> 
        <td>{{chromiumPerfTask.Description}}</td>

        <!-- Results col --> 
        <td class="nowrap">
          <template is="dom-if" if="{{chromiumPerfTask.Failure.Bool}}">
            <div style="color:red;">Failed</div>
          </template>
          <template is="dom-if" if="{{!chromiumPerfTask.TsCompleted.Int64}}">
            <div style="color:green;">Waiting</div>
          </template>
          <template is="dom-if" if="{{chromiumPerfTask.Results.String}}">
            <a href="{{chromiumPerfTask.Results.String}}" target="_blank">Overall Result</a>
            <br/>
            <a href="{{chromiumPerfTask.NoPatchRawOutput.String}}" target="_blank">NoPatch Raw Output</a>
            <br/>
            <a href="{{chromiumPerfTask.WithPatchRawOutput.String}}" target="_blank">WithPatch Raw Output</a>
          </template>
        </td>

        <!-- Arguments --> 
        <td class="nowrap">
          <template is="dom-if" if="{{chromiumPerfTask.BenchmarkArgs}}">
            <a href="javascript:void(0);" data-index$="{{index}}" data-type="benchmarkArgs">Benchmark Args</a>
            <br/>
          </template>
          <template is="dom-if" if="{{chromiumPerfTask.BrowserArgsNoPatch}}">
            <a href="javascript:void(0);" data-index$="{{index}}" data-type="nopatchBrowserArgs">NoPatch Browser Args</a>
            <br/>
          </template>
          <template is="dom-if" if="{{chromiumPerfTask.BrowserArgsWithPatch}}">
            <a href="javascript:void(0);" data-index$="{{index}}" data-type="withpatchBrowserArgs">WithPatch Browser Args</a>
            <br/>
          </template>
        </td>

        <!-- Patches -->
        <td>
          <template is="dom-if" if="{{chromiumPerfTask.ChromiumPatch}}">
            <a href="javascript:void(0);" data-index$="{{index}}" data-type="chromiumPatch">Chromium</a>
            <br/>
          </template>
          <template is="dom-if" if="{{chromiumPerfTask.BlinkPatch}}">
            <a href="javascript:void(0);" data-index$="{{index}}" data-type="blinkPatch">Blink</a>
            <br/>
          </template>
          <template is="dom-if" if="{{chromiumPerfTask.SkiaPatch}}">
            <a href="javascript:void(0);" data-index$="{{index}}" data-type="skiaPatch">Skia</a>
          </template>
        </td>
      </tr>
    </tr>
    </template>
    </table>

  </template>
</dom-module>

<script>
   Polymer({
     is: "chromium-perf-runs-sk",
     properties: {
       chromiumPerfTasks: {
         type: Array,
         value: function() { return []; },
       },
       defaultSize: {
         type: Number,
         value: 5,
       },
       constrainByUser: {
         type: Boolean,
         value: false,
         observer: 'constrainByUserChanged',
       },
       myRunsConstrainText: {
         type: String,
         value: "View only my runs",
       },
       allRunsConstrainText: {
         type: String,
         value: "View all runs",
       },
       constrainButtonText: {
         type: String,
         value: "",
       },
       pagination: {
         type: Object,
         value: function() { return {}; },
       },
       pageChangedHandler: {
         type: Object,
         value: function() { return null; },
       },
      
     },

     ready: function() {
       this.constrainButtonText = this.myRunsConstrainText;
       this.pagination = {"offset": 0, "size": this.defaultSize};
       this.pageChangedHandler = this.reload.bind(this);
       this.reload();

       var that = this;
       this.$.runshistory.addEventListener('click', function(e) {
         var anchor = sk.findParent(e.target, "A");
         if (anchor != null) {
           var id = anchor.dataset.index;
           if (anchor.dataset.type == "benchmarkArgs") {
             that.toggleDialog(that.getBenchmarkArgsId(id));
           } else if (anchor.dataset.type == "nopatchBrowserArgs") {
             that.toggleDialog(that.getBrowserArgsNoPatchId(id));
           } else if (anchor.dataset.type == "withpatchBrowserArgs") {
             that.toggleDialog(that.getBrowserArgsWithPatchId(id));
           } else if (anchor.dataset.type == "chromiumPatch") {
             that.toggleDialog(that.getChromiumPatchId(id));
           } else if (anchor.dataset.type == "blinkPatch") {
             that.toggleDialog(that.getBlinkPatchId(id));
           } else if (anchor.dataset.type == "skiaPatch") {
             that.toggleDialog(that.getSkiaPatchId(id));
           }
         }
       });
     },

     reload: function() {
       var queryParams = {
         "offset": this.pagination.offset,
         "size": this.pagination.size,
       }
       if (this.constrainByUser) {
         var username = $$$("login-sk").email;
         if (!username) {
           window.open("/login/", "_self");
         }
         queryParams["username"] = username;
       }
       chromiumPerfQueryStr = "?" + sk.query.fromObject(queryParams);
       var that = this;
       sk.post('/_/get_chromium_perf_tasks' + chromiumPerfQueryStr).then(JSON.parse).then(function(json) {
         that.chromiumPerfTasks = json.data;
         that.pagination = json.pagination;
       }).catch(function(err) {
         $$$('paper-toast').text = err;
         $$$('paper-toast').show();
       });
     },

     getBenchmarkArgsId: function(index) {
       return "benchmark_args" + index;
     },

     getBrowserArgsNoPatchId: function(index) {
       return "browser_args_nopatch" + index;
     },

     getBrowserArgsWithPatchId: function(index) {
       return "browser_args_withpatch" + index;
     },

     getChromiumPatchId: function(index) {
       return "chromium_patch" + index;
     },

     getBlinkPatchId: function(index) {
       return "blink_patch" + index;
     },

     getSkiaPatchId: function(index) {
       return "skia_patch" + index;
     },

     resetPagination: function() {
       this.pagination.offset = 0;
       this.pagination.size = this.defaultSize;
     },

     constrainRuns: function() {
       this.constrainByUser = !this.constrainByUser;
       this.resetPagination();
       this.reload();
     },

     constrainByUserChanged: function() {
       this.constrainButtonText = this.myRunsConstrainText;
       if (this.constrainByUser) {
         this.constrainButtonText = this.allRunsConstrainText;
       }
     },

     toggleDialog: function(id) {
       Polymer.dom(this.root).querySelector('#' + id).toggle();
     },

     formatTimestamp: function(timestamp) {
       return getFormattedTimestamp(timestamp);
     },
  });
</script>
