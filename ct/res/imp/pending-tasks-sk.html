<!--
  This in an HTML Import-able file that contains the definition
  of the following elements:

    <pending-tasks-sk>

  To use this file import it:

    <link href="/res/imp/pending-tasks-sk.html" rel="import" />

  Usage:

    <pending-tasks-sk></pending-tasks-sk>
-->

<dom-module id="pending-tasks-sk">
  <style>
    paper-dialog {
      min-width: 200px;
    }
    table.queue {
      border-spacing: 0px;
      padding-top: 2em;
    }
    tr.headers {
      background-color: #CCCCFF;
      text-align: center;
    }
    td.nowrap {
      white-space: nowrap;
    }
    th,
    td  {
      padding: 15px;
      border: solid black 1px;
    }
  </style>
  <template>

    <h2>Tasks in the Queue</h2>

    <!-- Section for popups. -->
    <template is="dom-repeat" items="{{pendingTasks}}" as="pendingTask" index-as="index">
      <paper-dialog heading="Task Details" id="{{ getTaskDetailsId(index) }}">
        <paper-dialog-scrollable>
          <pre>{{ formatTask(pendingTask) }}</pre>
        </paper-dialog-scrollable>
      </paper-dialog>
    </template>

    <table class="queue" id="queue">
      <tr class="headers">
        <td>Queue Position</td>
        <td>Added</td>
        <td>Task Type</td>
        <td>User</td>
        <td>Request</td>
      </tr>

      <template is="dom-repeat" items="{{pendingTasks}}" as="pendingTask" index-as="index">
        <tr>
          <!-- Queue Position col --> 
          <td>{{ incrementOne(index) }}</td>

          <!-- Added col --> 
          <td>{{ formatTimestamp(pendingTask.TsAdded.Int64) }}</td>

          <!-- Task Type col --> 
          <td>{{pendingTask.TaskType}}</td>

          <!-- User col --> 
          <td>{{pendingTask.Username}}</td>

          <!-- Request col -->
          <td class="nowrap">
            <a href="javascript:void(0);" data-id$="{{index}}">Task Details</a>
          </td>
        </tr>
      </template>
    </table>
  </template>
</dom-module>


<script>
   Polymer({
     is: "pending-tasks-sk",
     properties: {
       pendingTasks: {
         type: Array,
         value: [],
       },
     },

     ready: function() {
       var queryParams = {
         "size": 100,
         "not_completed": true,
       }
       var queryStr = "?" + sk.query.fromObject(queryParams);
       var that = this;
       sk.post('/_/get_chromium_perf_tasks' + queryStr).then(JSON.parse).then(function(json) {
         that.updatePendingTasks(json.data, "ChromiumPerfTask");
       }).catch(sk.errorMessage);
       sk.post('/_/get_recreate_page_sets_tasks' + queryStr).then(JSON.parse).then(function(json) {
         that.updatePendingTasks(json.data, "RecreatePageSets");
       }).catch(sk.errorMessage);
       sk.post('/_/get_recreate_webpage_archives_tasks' + queryStr).then(JSON.parse).then(function(json) {
         that.updatePendingTasks(json.data, "RecreateWebpageArchives");
       }).catch(sk.errorMessage);
       sk.post('/_/get_chromium_build_tasks' + queryStr).then(JSON.parse).then(function(json) {
         that.updatePendingTasks(json.data, "ChromiumBuild");
       }).catch(sk.errorMessage);

       this.$.queue.addEventListener('click', function(e) {
         var anchor = sk.findParent(e.target, "A");
         if (anchor != null) {
           var index = anchor.dataset.id;
           that.toggleDialog(that.getTaskDetailsId(index));
         }
       });
     },

     incrementOne: function(index) {
       return index + 1;
     },

     getTaskDetailsId: function(index) {
       return "task_details" + index;
     },

     formatTask: function(task) {
       return JSON.stringify(task, null, 4);
     },

     updatePendingTasks: function(tasks, tasksType) {
       for (index in tasks) {
         tasks[index]["TaskType"] = tasksType;
       }
       this.pendingTasks = this.pendingTasks.concat(tasks)
       // Sort pending tasks according to TsAdded.
       this.pendingTasks.sort(function(a, b){return a["TsAdded"]["Int64"] - b["TsAdded"]["Int64"]});
     },

     toggleDialog: function(id) {
       Polymer.dom(this.root).querySelector('#' + id).toggle();
     },

     formatTimestamp: function(timestamp) {
       return getFormattedTimestamp(timestamp);
     },
  });
</script>
