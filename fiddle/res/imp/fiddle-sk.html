<!-- The <fiddle-sk> custom element declaration.

  Handles displaying and running a fiddle. Note that the code
  should be supplied as a child element textarea.

  Attributes:
    width  - The width of the fiddle image.
    height - The height of the fiddle image.
    source - The index of the source image to use as input.

  Methods:
    None.

  Events:
    fiddle-success - generates an event when a succesful run is complete. The event contains
      the hash of the new fiddle, to be used to retrieve the resultant images.
-->
<link rel="stylesheet" href="/res/common/css/md.css" type="text/css" media="all">
<link rel="import" href="bower_components/paper-spinner/paper-spinner.html">
<dom-module id="fiddle-sk">
  <style>
    img {
      box-shadow: 2px 2px 5px gray;
      display: inline-block;
      background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAAAAAA6mKC9AAAAAXNSR0IArs4c6QAAAAJiS0dEAP+Hj8y/AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAB3RJTUUH3gUBEi4DGRAQYgAAAB1JREFUGNNjfMoAAVJQmokBDdBHgPE/lPFsYN0BABdaAwN6tehMAAAAAElFTkSuQmCC');
    }

    #submit {
      margin-top: 1em;
    }

    button {
      margin-left: 0;
    }

    paper-spinner {
      display: inline-block;
      top: 10px;
    }

    #results {
      margin-top: 1em;
    }

    #results > div {
      display: inline-block;
      margin-right: 1em;
    }

    :host {
      padding: 1.5em;
    }
  </style>
  <template>
    <content></content>
    <div id=submit>
      <button on-tap="_run">Run</button>
      <paper-spinner id=running></paper-spinner>
    </div>
    <template is="dom-if" if="{{_hasImages(fiddlehash)}}">
      <div id=results class="horizontal layout">
        <div class="vertical layout center-justified">
          <img src="/i/{{fiddlehash}}_raster.png" width="{{width}}" height="{{height}}">
          <p>CPU</p>
        </div>
        <div class="vertical layout center-justified">
          <img src="/i/{{fiddlehash}}_gpu.png" width="{{width}}" height="{{height}}">
          <p>GPU</p>
        </div>
        <div class="vertical layout center">
          <a href="/i/{{fiddlehash}}.pdf">PDF</a>
        </div>
        <div class="vertical layout center">
          <a href="/i/{{fiddlehash}}.skp">SKP</a>
        </div>
      </div>
    </template>
  </template>
</dom-module>

<script>
  Polymer({
    is: "fiddle-sk",
    properties: {
      width: {
        type: Number,
        value: 256,
        reflectToAttribute: true,
      },
      height: {
        type: Number,
        value: 256,
        reflectToAttribute: true,
      },
      source: {
        type: Number,
        value: 0,
        reflectToAttribute: true,
      },
      fiddlehash: {
        type: String,
        value: "",
        reflectToAttribute: true,
      },
    },

    ready: function() {
    },

    _run: function() {
      this.fiddlehash = "";
      this.$.running.active = true;
      body = {
        code: $$$('textarea', this).value,
        options: {
          width: this.width,
          height: this.height,
          source: this.source,
        }
      };
      sk.post("/_/run", JSON.stringify(body)).then(JSON.parse).then(function(json) {
        this.fiddlehash = json.fiddleHash;
        this.$.running.active = false;
        this.fire("fiddle-success", json.fiddleHash);
      }.bind(this)).catch(function(err) {
        this.$.running.active = false;
        sk.reportError(err);
      }.bind(this));
    },

    _hasImages: function(fiddlehash) {
      return fiddlehash != "";
    },

  });
</script>
