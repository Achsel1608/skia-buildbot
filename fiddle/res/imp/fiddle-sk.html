<!-- The <fiddle-sk> custom element declaration.

  Handles displaying and running a fiddle. Note that the code
  should be supplied as a child element textarea.

  Attributes:
    width        - The width of the fiddle image.
    height       - The height of the fiddle image.
    source       - The index of the source image to use as input.
    bug_link     - If true then display a link to report a bug.
    embed_button - If true then display the embed button.

  Methods:
    None.

  Events:
    fiddle-success - generates an event when a succesful run is complete. The event contains
      the hash of the new fiddle, to be used to retrieve the resultant images.
-->
<link rel="stylesheet" href="/res/common/css/md.css" type="text/css" media="all">
<link rel="import" href="bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="/res/common/imp/9/details-summary.html">
<link rel="import" href="/res/common/imp/9/toggle.html">
<link rel="import" href="/res/imp/bower_components/paper-input/paper-input.html">
<style type="text/css" media="screen">
    .CodeMirror .error {
      background: #f88;
    }

    .CodeMirror-lines,
    .CodeMirror-scroll
    {
      background-color: #eee;
    }

    .CodeMirror {
      border: solid gray 1px;
      height: auto !important;

      z-index: 0;
    }

    .CodeMirror-scroll {
      overflow-y: hidden;
      overflow-x: auto;
    }
</style>

<dom-module id="fiddle-sk">
  <style>
    #namer,
    #embedder {
      display: none;
      margin-left: 2em;
    }

    #namer.display,
    #embedder.display {
      display: block;
    }


    img {
      box-shadow: 2px 2px 5px gray;
      display: inline-block;
      background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAAAAAA6mKC9AAAAAXNSR0IArs4c6QAAAAJiS0dEAP+Hj8y/AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAB3RJTUUH3gUBEi4DGRAQYgAAAB1JREFUGNNjfMoAAVJQmokBDdBHgPE/lPFsYN0BABdaAwN6tehMAAAAAElFTkSuQmCC');
    }

    #submit {
      margin-top: 1em;
    }

    button.action {
      margin-left: 0;
    }

    paper-spinner {
      display: inline-block;
      top: 10px;
    }

    #results {
      margin-top: 1em;
    }

    #results > div {
      display: inline-block;
      margin-right: 1em;
    }

    :host {
      padding: 1.5em;
    }

    .compile-error {
      margin: 0 0 0 2em;
      font-weight: bold;
      cursor: pointer;
    }

    .compile-error:hover {
      background: #eee;
    }

    h2 {
      color: #E31A1C;
      font-size: 18px;
    }

    details-sk {
      display: inline-block;
      padding-bottom: 1em;
    }

    .options {
      margin-left: 3em;
    }

    #bug {
      display: inline-block;
      margin-left: 1em;
    }

    iron-selector img {
      margin: 0.5em;
    }

    img.iron-selected {
      border: solid #1F78B4 3px;
    }

    .source-select {
      margin: 1em 0 0.5em 0;
    }

    paper-input {
      display: inline-block;
    }

  </style>
  <template>
    <template is="dom-if" if="{{display_options}}">
      <details-sk>
        <summary-sk>Options</summary-sk>
        <div class=options>
          <paper-input label="Width" size=5 auto-validate allowed-pattern="[0-9]" value="{{width}}"></paper-input>
          <paper-input label="Height" size=5 auto-validate allowed-pattern="[0-9]" value="{{height}}"></paper-input>
          <pre class=source-select>SkBitmap source;</pre>
          <iron-selector selected="{{source}}" attr-for-selected="name" class="layout horizontal wrap">
            <template is="dom-repeat" items="{{sources}}">
              <img width=64 height=64 name="{{item}}" src="/s/{{item}}">
            </template>
          </iron-selector>
        </div>
      </details-sk>
    </template>
    <content></content>
    <div id=submit>
      <button class=action on-tap="_run">Run</button>
      <paper-spinner id=running></paper-spinner>
      <template is="dom-if" if="{{bug_link}}">
        <a id=bug target=_blank href$="{{_bugLink(fiddlehash)}}">File Bug</a>
      </template>
      <template is="dom-if" if="{{embed_button}}">
        <toggle-display-sk>Embed</toggle-display-sk>
        <div id=embedder>
          <h3>Embed as an iframe:</h3>
          <input type="text" readonly size=150 value="&lt;iframe src='https://fiddle.skia.org/iframe/{{fiddlehash}}' width='900' height='550' style='border: solid #00a 1px; border-radius: 5px;'/>">
          <p>Embed as an image with a backlink:</p>
          <input type="text" readonly size=150 value="&lt;a href='https://fiddle.skia.org/c/{{fiddlehash}}'>&lt;img src='https://fiddle.skia.org/i/{{fiddlehash}}_raster.png'>&lt;/a>">
        </div>
      </template>
        <toggle-display-sk disabled$={{_not_logged_in}}>Name</toggle-display-sk>
        <div id=namer>
          <h3>Create a name for this fiddle:</h3>
          <paper-input id=name label="Name" placeholder="fiddle_name_goes_here" size=40 auto-validate allowed-pattern="[0-9a-zA-Z_]" value="{{_name}}"></paper-input>
          <!-- Add a pop-up menu here that has completions based on what's been typed so far, and also any names that this page has loaded previously.-->
          <paper-checkbox id=overwrite title="Overwrite the existing name if one exists.">Overwrite</paper-checkbox>
          <button class=save on-tap="_submit_name" disabled="{{_isEmpty(_name)}}">Save</button>
        </div>

    </div>
    <div on-tap="_errSelect">
      <template is="dom-if" if="{{_hasCompileErrors(_compile_errors)}}">
        <h2>Compilation Errors</h2>
        <template is="dom-repeat" items="{{_compile_errors}}">
          <pre class=compile-error data-line$="{{item.line}}" data-col$="{{item.col}}">{{item.text}}</pre>
        </template>
      </template>
    </div>
    <template is="dom-if" if="{{_runtime_error}}">
      <h2>Runtime Errors</h2>
      <div>{{_runtime_error}}</div>
    </template>
    <template is="dom-if" if="{{_hasImages(fiddlehash, _compile_errors, _runtime_error)}}">
      <div id=results class="horizontal layout">
        <div class="vertical layout center-justified">
          <img src="/i/{{fiddlehash}}_raster.png" width="{{width}}" height="{{height}}">
          <p>CPU</p>
        </div>
        <div class="vertical layout center-justified">
          <img src="/i/{{fiddlehash}}_gpu.png" width="{{width}}" height="{{height}}">
          <p>GPU</p>
        </div>
        <div class="vertical layout center">
          <a href="/i/{{fiddlehash}}.pdf">PDF</a>
        </div>
        <div class="vertical layout center">
          <a href="/i/{{fiddlehash}}.skp">SKP</a>
        </div>
      </div>
    </template>
  </template>
</dom-module>

<script>
  Polymer({
    is: "fiddle-sk",

    properties: {
      width: {
        type: Number,
        value: 256,
        reflectToAttribute: true,
      },
      height: {
        type: Number,
        value: 256,
        reflectToAttribute: true,
      },
      source: {
        type: Number,
        value: 0,
        reflectToAttribute: true,
      },
      sources: {
        type: Array,
        value: function() { return []; },
        reflectToAttribute: true,
      },
      fiddlehash: {
        type: String,
        value: "",
        reflectToAttribute: true,
      },
      bug_link: {
        type: Boolean,
        value: false,
        reflectToAttribute: true,
      },
      embed_button: {
        type: Boolean,
        value: false,
        reflectToAttribute: true,
      },
      display_options: {
        type: Boolean,
        value: false,
        reflectToAttribute: true,
      },
      _compile_errors: {
        type: Array,
        value: function() { return []; },
        reflectToAttribute: false,
      },
      _runtime_error: {
        type: String,
        value: "",
        reflectToAttribute: false,
      },
      _not_logged_in: {
        type: Boolean,
        value: true,
        reflectToAttribute: false,
      },
      _name: {
        type: String,
        value: "",
        reflectToAttribute: false,
      },
    },

    ready: function() {
      this._errorLinesRe = /draw.cpp:([0-9]+):([0-9]+):/;

      this._editor = CodeMirror.fromTextArea($$$('textarea', this), {
        theme: "default",
        lineNumbers: true,
        matchBrackets: true,
        lineWrapping: true,
        mode: "text/x-c++src",
        indentUnit: 4,
      });

      this._editor.setSize(this._editor.defaultCharWidth() * 100, null);
      this.async(function() {
        this._editor.refresh();
      }.bind(this), 100);

      this._editor.on('beforeChange', function(instance, changeObj) {
        var startLine = changeObj.from.line;
        var endLine = changeObj.to.line;

        for (var i = 0; i <= this._editor.lineCount(); i++) {
          this._editor.removeLineClass( i, "wrap", "error" );
        }
      }.bind(this));

      sk.Login.then(function(status) {
        this._not_logged_in = (status.Email == "");
      }.bind(this));
    },

    _run: function() {
      this._run_impl({});
    },

    _submit_name: function() {
      this._run_impl({
        name: this._name,
        overwrite: this.$.overwrite.checked,
      });
    },

    _run_impl: function(extra) {
      this._editor.save();
      this.fiddlehash = "";
      this.$.running.active = true;
      body = {
        code: $$$('textarea', this).value,
        options: {
          width: +this.width,
          height: +this.height,
          source: +this.source,
        }
      };
      for (key in extra) {
        body[key] = extra[key];
      }
      sk.post("/_/run", JSON.stringify(body)).then(JSON.parse).then(function(json) {
        this.fiddlehash = json.fiddleHash;
        this._compile_errors = json.compile_errors || [];
        this._runtime_error = json.runtime_error || "";
        this.$.running.active = false;
        this.fire("fiddle-success", json.fiddleHash);
        this._compile_errors.forEach(function(err) {
          this._editor.addLineClass(+err.line-1, "wrap", "error");
        }.bind(this));
        this.$.overwrite.checked = false;
      }.bind(this)).catch(function(err) {
        this.$.running.active = false;
        sk.errorMessage(err);
      }.bind(this));
    },

    _errSelect: function(e) {
      if (e.target.nodeName == "PRE") {
        this._editor.setCursor(+e.target.dataset.line-1, +e.target.dataset.col-1);
        this._editor.focus();
      }
    },

    _bugLink: function(fiddleHash) {
      var comment = "Visit this link to see the issue on fiddle:\n\n https://fiddle.skia.org/c/" + fiddleHash;
      return "https://bugs.chromium.org/p/skia/issues/entry?" + sk.query.fromObject({
        comment: comment,
      });
    },

    _hasImages: function(fiddlehash, compile_errors, runtime_error) {
      return fiddlehash != "" && runtime_error == "" && (compile_errors.length == 0);
    },

    _hasCompileErrors: function(compile_errors) {
      return compile_errors.length > 0;
    },

    _isEmpty: function(name) {
      return name == "";
    },

  });
</script>
