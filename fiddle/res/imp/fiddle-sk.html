<!-- The <fiddle-sk> custom element declaration.

  Handles displaying and running a fiddle. Note that the code
  should be supplied as a child element textarea.

  Attributes:
    width  - The width of the fiddle image.
    height - The height of the fiddle image.
    source - The index of the source image to use as input.

  Methods:
    None.

  Events:
    fiddle-success - generates an event when a succesful run is complete. The event contains
      the hash of the new fiddle, to be used to retrieve the resultant images.
-->
<link rel="stylesheet" href="/res/common/css/md.css" type="text/css" media="all">
<link rel="import" href="bower_components/paper-spinner/paper-spinner.html">
<dom-module id="fiddle-sk">
  <style>
    button {
      display: block;
    }
  </style>
  <template>
    <content></content>
    <button on-tap="_run">Run</button>
    <paper-spinner id=running></paper-spinner>
    <template is="dom-if" if="{{_hasImages(fiddlehash)}}">
      <img src="/i/{{fiddlehash}}_raster.png" width="{{width}}" height="{{height}}">
      <img src="/i/{{fiddlehash}}_gpu.png" width="{{width}}" height="{{height}}">
      <a href="/i/{{fiddlehash}}.pdf">PDF</a>
      <a href="/i/{{fiddlehash}}.skp">SKP</a>
    </template>
  </template>
</dom-module>

<script>
  Polymer({
    is: "fiddle-sk",
    properties: {
      width: {
        type: Number,
        value: 256,
        reflectToAttribute: true,
      },
      height: {
        type: Number,
        value: 256,
        reflectToAttribute: true,
      },
      source: {
        type: Number,
        value: 0,
        reflectToAttribute: true,
      },
      fiddlehash: {
        type: String,
        value: "",
        reflectToAttribute: true,
      },
    },

    ready: function() {
    },

    _run: function() {
      this.fiddlehash = "";
      this.$.running.active = true;
      body = {
        code: $$$('textarea', this).value,
        options: {
          width: this.width,
          height: this.height,
          source: this.source,
        }
      };
      sk.post("/_/run", JSON.stringify(body)).then(JSON.parse).then(function(json) {
        console.log(json);
        this.fiddlehash = json.fiddleHash;
        this.$.running.active = false;
        this.fire("fiddle-success", json.fiddleHash);
      }.bind(this)).catch(function(err) {
        this.$.running.active = false;
        sk.reportError(err);
      }.bind(this));
    },

    _hasImages: function(fiddlehash) {
      return fiddlehash != "";
    },

  });
</script>
