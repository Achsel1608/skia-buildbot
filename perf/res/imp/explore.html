<!-- The <explore-sk> custom element declaration.

  Main page of Perf, for exploring data.

  Attributes:
    None.

  Events:
    None.

  Methods:
    None.

-->
<link rel="import" href="/res/imp/bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="/res/imp/bower_components/paper-tabs/paper-tabs.html">

<link rel="import" href="/res/common/imp/query2-sk.html" />
<link rel="import" href="/res/common/imp/paramset.html" />
<link rel="import" href="/res/common/imp/query-summary-sk.html" />
<link rel="stylesheet" href="/res/common/css/md.css">

<link rel="import" href="/res/imp/plot-simple.html" />
<link rel="import" href="/res/imp/commit-detail-panel.html" />
<link rel="import" href="/res/imp/highlight.html" />

<dom-module id="explore-sk">
  <style include="iron-flex iron-flex-alignment iron-positioning">
    h3 {
      margin: 0;
    }

    #selections {
      margin: 0 1em;
    }

    #commits,
    #paramset {
      display: inline-block;
      margin: 0.5em;
      overflow-y: auto;
      height: 480px;
    }

    #commits.hidden,
    #paramset.hidden {
      display: none;
    }

    paper-tabs {
      background: #A6CEE3;
      color: #555;
    }

    paper-tab.iron-selected {
      background: #1F78B4;
      color: white;
    }

    #tabs {
      margin: 1em 0 0 1em;
    }

    #detail {
      border: #1F78B4 2px solid;
      margin: 0;
    }

  </style>
  <template>
    <div>
      <div class="layout horizontal">
        <div>
          <highlightbar-sk id=highlight></highlightbar-sk>
          <plot-simple-sk width=640 height=480 id=plot></plot-simple-sk>
        </div>
        <div id=tabs class="flex">
          <paper-tabs selected=0 id=detailtab no-bar on-iron-select="_tabSelect">
            <paper-tab>Params</paper-tab>
            <paper-tab id=commitsTab disabled>Commits</paper-tab>
          </paper-tabs>
          <div id=detail>
            <paramset-sk id=paramset clickable-values></paramset-sk>
            <commit-detail-panel-sk class=hidden id=commits></commit-detail-panel-sk>
          </div>
        </div>
      </div>
      <div class="layout horizontal wrap">
        <query2-sk id=query></query2-sk>
        <div class="layout vertical" id=selections>
          <h3>Selections</h3>
          <query-summary-sk id=summary></query-summary-sk>

          <div>
            Matches: <span id=matches></span>
          </div>
        </div>
        <div class="layout vertical">
          <button on-tap="_add">Plot</button>
        </div>
      </div>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is: "explore-sk",

    properties: {
      // Keep track of the data sent to plot.
      _lines: {
        type: Object,
        value: function() { return {}; },
      },
    },

    ready: function() {
      // Keep track of whether a request is inflight to count the number of traces that match the current query.
      this._countInProgress = false;

      // Populate the query element.
      sk.get("/_/paramset/").then(JSON.parse).then(function(json) {
        this.$.query.setParamset(json);
      }.bind(this)).catch(sk.errorMessage);

      // Reflect the current query to the query summary.
      this.$.query.addEventListener("query-change", function(e){
        this.$.summary.selection = e.detail.q;
        this._updateCount();
      }.bind(this));

      // Highlight trace when a paramset value is clicked.
      this.$.paramset.addEventListener("paramset-key-value-click", function(e){
        var keys = [];
        Object.keys(this._lines).forEach(function(key) {
          if (sk.key.matches(key, e.detail.key, e.detail.value)) {
            keys.push(key);
          }
        });
        // Additively highlight if the ctrl key is pressed.
        if (!e.detail.ctrl) {
          this.$.plot.clearHighlight();
        }
        this.$.plot.setHighlight(keys);
      }.bind(this));

      // Reflect the focused trace in the paramset.
      this.$.plot.addEventListener("trace_focused", function(e) {
        this.$.paramset.clearHighlight();
        this.$.paramset.setHighlight(sk.key.toObject(e.detail.id));
        this.$.highlight.key = e.detail.id;
        this.$.highlight.value = e.detail.pt[1];
      }.bind(this));

      // Highlight a trace when it is clicked on.
      this.$.plot.addEventListener("trace_selected", function(e) {
        this.$.plot.clearHighlight();
        this.$.plot.setHighlight(e.detail.id);
        this.$.commits.setCommitDetail([]);

        var x = e.detail.pt[0]|0;
        // loop backwards from x until you get the next
        // non 1e32 point.
        var commits = [this._dataframe.header[x]];
        var trace = this._dataframe.traceset[e.detail.id];
        for (var i = x-1; i >= 0; i--) {
          if (trace[i] != 1e32) {
            break;
          }
          commits.push(this._dataframe.header[i]);
        }
        // Request populated commits from the server.
        sk.post("/_/cid/", JSON.stringify(commits)).then(JSON.parse).then(function(json){
          this.$.commits.setCommitDetail(json);
          this.$.commitsTab.disabled = false;
          this.$.detailtab.selected = 1;
        }.bind(this)).catch(sk.errorMessage);
      }.bind(this));

      this._updateCount();
    },

    _updateCount: function() {
      if (this._countInProgress === true) {
        return
      }
      this._countInProgress = true;
      sk.post("/_/count/", this.$.query.current_query, "application/x-www-form-urlencoded").then(JSON.parse).then(function(json) {
        this._countInProgress = false;
        this.$.matches.textContent = json.count;
      }.bind(this)).catch(function() {
        this._countInProgress = false;
      });
    },

    _add: function() {
      sk.post("/_/search/", this.$.query.current_query, "application/x-www-form-urlencoded").then(JSON.parse).then(function(dataframe) {
        // Convert the dataframe into a form suitable for the plot element.
        var lines = {};
        Object.keys(dataframe.traceset).forEach(function(key) {
          var values = [];
          dataframe.traceset[key].forEach(function(y, x) {
            if (y != 1e32) {
              values.push([x, y]);
            }
          });
          lines[key] = values;
        });
        this._lines = lines;
        this._dataframe = dataframe;
        this.$.plot.removeAll();
        this.$.plot.addLines(lines);

        // Populate the paramset element.
        this.$.paramset.setParamSets([dataframe.paramset]);
      }.bind(this)).catch(sk.errorMessage);
    },

    _tabSelect: function() {
      var params_selected = (this.$.detailtab.selected == 0);
      this.$.paramset.classList.toggle('hidden', !params_selected);
      this.$.commits.classList.toggle('hidden', params_selected);
    },

  });
</script>
