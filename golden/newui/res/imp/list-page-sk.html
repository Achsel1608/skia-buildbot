  <!-- The <list-page-sk> custom element declaration.
  
    Displays the summary of tests that match the search query in the URL. 
  
    Attributes:
      None
  
    Events:
      None

    Methods:
      pageSelected - Called by the router when view is visible.
    
      pageDeselected - Called by the router when the view is no longer visible. 

  -->
<link rel="import" href="bower_components/polymer/polymer.html"> 
<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">

<link rel="import" href="../common/imp/9/sort.html">

<link rel="import" href="query-dialog-sk.html">
<link rel="import" href="activity-sk.html">
<link rel="import" href="test-summary-sk.html">
<link rel="import" href="shared-styles.html">

<dom-module id="list-page-sk">
  <template>
    <style include="iron-flex iron-flex-alignment"></style>
    <style include="shared-styles"></style>
    <style>
      test-summary-sk {
        display: block;
        margin-top: 0.5em;
      }
      
      .header {
        width: 25em;
      }

      .header.short {
        width: 10em;
      }

      corpus-chooser-sk {
        display: block;
      }

      #search {
        display: block;
      }

      .headToggle {
        font-size: 20px;
      }

      .headToggle paper-toggle-button {
        margin-right: 2em;
      }

      #core {
        margin-top: 2em;
      }

      .blameHeader {
        padding-top: 0.7em;
        padding-right: 0.57em;
        padding-bottom: 0.7em;
        padding-left: 0.57em;
        color: #1F78B4;
        text-transform: uppercase;
      }

      paper-button[disabled] {
        background: transparent;
        color: #1F78B4;
      }

      .topControl {
        margin-right: 2em;
        font-weight: bold;
      }

    </style>

    <div id="core" class="vertical layout">
      <activity-sk id="activityBar"></activity-sk>
      <div class="horizontal layout">
        <paper-button id="searchButton" class="topControl" raised><iron-icon icon="search"></iron-icon></paper-button>
        <paper-toggle-button id=head class="topControl" checked="{{_state.head}}">Head</paper-toggle-button>
        <paper-toggle-button id=include class="topControl" checked="{{_state.include}}">Include Ignored</paper-toggle-button>
        <paper-toggle-button id=pos class="topControl" checked="{{_state.pos}}">Positive</paper-toggle-button>
        <paper-toggle-button id=neg class="topControl" checked="{{_state.neg}}">Negative</paper-toggle-button>
        <paper-toggle-button id=unt class="topControl" checked="{{_state.unt}}">Untriaged</paper-toggle-button>
      </div>

      <query-dialog-sk id="queryDialog" trigger="searchButton"></query-dialog-sk>

      <sort-sk target="summaries">
        <paper-button class="header" data-key="name" data-alpha=true>Name</paper-button>
        <paper-button class="header short" disabled>Grid</paper-button>
        <paper-button class="header short" disabled >Cluster</paper-button>
        <paper-button class="header short" data-key="pos">Pos</paper-button>
        <paper-button class="header short" data-key="neg">Neg</paper-button>
        <paper-button class="header short" data-key="untriaged">Unt</paper-button>
        <paper-button class="header short" data-key="num">Total</paper-button>
        <span class="blameHeader">Blame</span>
      </sort-sk>
      <div id="summaries"></div>
    </div>
  </template>

  <script>
   (function() {
      var defaultState = {
       query:   "source_type=gm",
       head:    true,
       include: false,
       pos: false,
       neg: false, 
       unt: true 
      };

      var NAME_FIELD = "name";

      function stateFromQuery(defaultState) {
        var delta = sk.query.toObject(window.location.search.slice(1), defaultState);
        return sk.object.applyDelta(delta, defaultState);
      }

      function queryFromState(srcState) {
        var ret = sk.query.fromObject(srcState); 
        if (ret === '') {
          return ''; 
        }
        return '?' + ret; 
      }

      function setQuery(q) {
        history.pushState(null, "", window.location.origin + window.location.pathname + q);
      }

      Polymer({
        is: "list-page-sk",

        properties: {
          _state: {
            type: Object, 
            value: null,
            notify: true
          }
        },

        observers: [
          '_stateChanged(_state.*)'
        ],

        ready: function() {
          this.listen(this.$.searchButton, 'click', '_handleSearchButton');
          this.listen(this.$.queryDialog, 'edit', '_handleQueryEdit');
        }, 

        pageSelected: function(routeName) {
          this.set('_state', stateFromQuery(defaultState));
          this._loadParamset();
        },

        pageDeselected: function() {
          this._state = null;
        },

        _loadList: function() {
          var q = queryFromState(this._state);
          setQuery(q);
          this.$.activityBar.startSpinner("Loading ...");
          sk.get("/json/list" + q).then(JSON.parse).then(function (json) {
            // Remove the name field from the current query. 
            this._currentQuery = sk.query.toParamSet(this._state.query);
            delete this._currentQuery[NAME_FIELD];

            this._displaySummaries(json);
            this.$.activityBar.stopSpinner(); 
          }.bind(this)).catch(function(e) {
            this.$.activityBar.stopSpinner();
            sk.errorMessage(e);
          }.bind(this)); 
        },

        _displaySummaries: function(summaries) {
          var container = this.$.summaries;
          sk.clearChildren(container);
          summaries.forEach(function(c, i) {
            var s = document.createElement("test-summary-sk");
            s.summary = c; 
            s.search = this._searchStr(c);
            container.appendChild(s);
          }.bind(this));
        }, 

        _searchStr: function(summary) {
          var state = sk.object.shallowCopy(this._state); 
          var q = sk.object.shallowCopy(this._currentSelections); 
          q[NAME_FIELD] = summary.name; 
          state.query = sk.query.fromObject(q); 
          return sk.query.fromObject(state);
        }, 

        _loadParamset: function() {
          this.$.searchButton.disabled = true;
          sk.get("/json/paramset").then(JSON.parse).then(function (json) {
            this.$.queryDialog.queryEle.setParamSet(json);
            this.$.searchButton.disabled = false;
          }.bind(this)).catch(sk.errorMessage);          
        },

        _stateChanged: function() {
          if (!this._state) {
            return; 
          }
          this._loadList(); 
        },

        _handleQueryEdit: function(ev) {
          ev.stopPropagation(); 
          this.set('_state.query', ev.detail); 
        },

        _handleSearchButton: function() {
          this.$.queryDialog.open(this._state.query);
        }

      });
    })();

  </script>
</dom-module>
