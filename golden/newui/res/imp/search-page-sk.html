<!--
  The <search-page-sk> custom element declaration.

  Shows the results of a search request. 
  It sends the query string as a JSON request to the 
  search entpoint ('/json/search') and renders the result. 

  It assumes to the be part of a client site routed system
  of views and therefore offers the 'pageSelected' and 'pageUnselected'
  functions. These need to be called whenever the page goes 
  in and out of view. 

  Attributes:
    None

  Events:
    None

  Methods:
    pageSelected - to be called with the route name as an argument 
                   whenever this view is the foreground view. 

    pageUnselected - to be called when this page goes out of view. 
-->

<link rel="import" href="bower_components/polymer/polymer.html"> 

<link rel=import href="detail-list-sk.html">
<link rel=import href="digest-details-sk.html">
<link rel="import" href="activity-sk.html">

<dom-module id="search-page-sk">
  <template>
    <style>
      digest-details-sk {
        display: block;
        box-shadow: 3px 3px 6px 1px rgba(133,133,133,1);
        margin-top: 1em;
        margin-bottom: 1em;
        margin-left: 3em;
        padding: 1em;
      }  

      digest-details-sk[data-focus] {
        box-shadow: 3px 3px 6px 5px #FF7F00;
      }
    </style>  
    <activity-sk id="activitySearch" busy="{{_hideAll}}"></activity-sk>
    <div hidden$="{{_hideAll}}">
      <div id="missing" hidden$="{{_hasEntries(data)}}">
        No digests match your query.
      </div>
      <div hidden$="{{!_hasEntries(data)}}">
        <detail-list-sk id="detailList">
          <template is="dom-repeat" items="{{data.digests}}">
            <digest-details-sk 
                    id$="{{_entryId(item)}}"
                    triage
                    details="[[item]]"
                    commits="[[data.commits]]">
            </digest-details-sk>
          </template>
        </detail-list-sk>
      </div>
    </div>
  </template>
  <script>
    Polymer({
      is: "search-page-sk",

      properties: {
        data: {
          type: Object, 
          value: function() { return {}; }
        }
      },

      pageSelected: function() {
        this.$.detailList.startUse();
        this._loadData();
      },

      pageDeselected: function() {
        this.$.detailList.endUse(); 
      },

      _loadData: function() {
        var q = window.location.search;
        this.$.activitySearch.startSpinner("Loading ...");
        sk.get("/json/search" + q).then(JSON.parse).then(function (json) {
          this.set('data', json);
          this.$.activitySearch.stopSpinner();
        }.bind(this)).catch(function(e) {
          this.$.activitySearch.stopSpinner();
          sk.errorMessage(e);
        }.bind(this));
      },

      _entryId: function(item) {
        return item.test + '-' + item.digest; 
      },

      _hasEntries: function(data) {
        return data && data.digests && data.digests.length > 0;
      }
    });
  </script>
</dom-module>
