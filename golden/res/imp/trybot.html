<!-- The <trybots-list-sk> custom element declaration.

  Renders a list of Rietveld issues that have trybot runs associated with them.

  Attributes: None

  Events: None

  Methods: None

-->
<polymer-element name="trybots-list-sk">
  <template>
    <style type="text/css" media="screen">
      .nameHeader,
      .issueHeader,
      .dateTimeHeader,
      .subjectHeader,
      .patchsetHeader {
        font-weight: bold;
      }

      .nameHeader,
      .nameValue {
        width: 8em;
      }

      .dateTimeHeader,
      .dateTimeValue {
        width: 12em;
      }

      .subjectHeader,
      .subjectValue {
        min-width: 15em;
        max-width: 35em;
      }

      .issueHeader,
      .issueValue {
        width: 6em;
      }

      .patchsetHeader,
      .patchsetValue {
        width: 7em;
      }

      .headerContainer {
        padding-top: 2em;
      }

      tr.rowEntry:hover td {background:#DDDDDD}
    </style>
    <paging-sk pagination="{{pagination}}" on-pagechange="{{pageChangedHandler}}"></paging-sk>
      <table class="headerContainer">
        <thead>
          <tr>
            <td class="issueHeader">Issue</td>
            <td class="patchsetHeader">Results<br>Up To</td>
            <td class="nameHeader">Owner</td>
            <td class="dateTimeHeader">Updated</td>
            <td class="subjectHeader">Subject</td>
          </tr>
          <tr template repeat="{{entry in trybotEntries}}" class="rowEntry">
            <td class="issueValue"><a href="{{entry.url}}" target="_blank" title="See codereview in a new window">{{entry.id}}</a></td>
            <td class="patchsetValue"><a href="/search2?issue={{entry.id}}&unt=true&query={{ page.query | queryStr }}&master=false" title="Results up to Patchset {{entry.patchsets.length}}">Patchset {{entry.patchsets.length}}</a></td>
            <td class="nameValue">{{entry.owner}}</td>
            <td class="dateTimeValue">{{entry.updated | _toLocalDate}}</td>
            <td class="subjectValue">{{entry.subject}}</td>
          </tr>
      </table>
      <error-toast-sk></error-toast-sk>
  </template>
  <script>
    Polymer({
      ready: function() {
        this.pagination = {
          size: 100, 
          offset: 0
        }; 

        this.page = {
          state: {},
          query: {
              "source_type": "gm"
          }
        };

        // Note: This forces and immediate trigger of reload.
        sk.stateReflector(this.page, this._reload.bind(this));

        // Set up the paging change handler and load the data.
        this.pageChangedHandler = this._reload.bind(this);
      },

      // Load or reload the listing.
      _reload: function() {
        var URL = '_/trybot?query='+ this.queryStr(this.page.query);

        if (this.pagination !== null) {
          URL += '&' + sk.query.fromObject({
            offset: this.pagination.offset,
            size: this.pagination.size
          });
        }

        this._handleServerResponse(sk.get(URL));
      },

      queryStr: function(q) {
        return encodeURIComponent(sk.query.fromObject(q));
      },

      _handleServerResponse: function(promise) {
        promise.then(JSON.parse).then(function(json) {
          this.trybotEntries = json.data;
          this.pagination = json.pagination;
        }.bind(this)).catch(sk.errorMessage);
      },

      _toLocalDate: function(timeStampSec) {
        return (new Date(timeStampSec * 1000)).toLocaleString();
      }
    });

  </script>
</polymer-element>
