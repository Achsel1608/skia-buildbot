<!-- The <grid-sk> custom element declaration.

Displays thumbnails in a 2-dimensional grid, also responds to mouseover events
on each image. The top row and the left most column are the thumbnails of the
sources, and the rest of the grid is filled in with the thumbnails of the
diffs of the images. The layout looks like:

   W T T T
   L D D D
   L D D D

Where:
  W = A white thumbnail to hold the space.
  T = A source thumbnail along the top.
  L = A source thumbnail along the left.
  D = A diff thumbnail between the top and left source images.

  Attributes:
    value - A dictionary of the form:

        {
          top: [img1, img2, ...]
          left: [imgA, imgB, ...]
          grid: [
            [diff1A, diff2A, ...],
            [diff1B, diff2B, ...],
          ]
        }

      Where imgX looks like:

         {
           thumb: "https:/....", // URL of thumbnail.
           digest: "abc12..."    // The image digest.
         }

      And diffXY looks like:

        {
          thumb:            "https://...",  // URL of thumbnail.
          topDigest:        "abc123...",    // Digest of top image.
          leftDigest:       "999def...",    // Digest of left image.
          numDiffPixels:    27,             // Number of differing pixels.
          pixelDiffPercent: 1.1,            // Percent of differing pixels.
          maxRGBADiffs:     [254, 0, 0, 0], // Max diffs per RGBA channels.
        }

  Events:
    'diff-focus'
       e.detail contains the diffXY info associated with that thumbnail.

  Methods:
    markChanged(digest) - Change the display of the thumbnail of source image
      'digest' to reflect that its triage status has changed.
-->
<polymer-element name="grid-sk">
  <template>
    <style type="text/css" media="screen">
      img {
        margin: 5px;
        border: solid 2px lightgray;
      }

      img.noBorder {
        border: solid 2px white;
      }

      img.changed {
        border: solid 2px #D95F02;
      }
    </style>
    <div id=container vertical layout>
      <div horizontal layout>
        <img src="/res/img/white.png" class=noBorder />
        <template repeat="{{t in value.top}}">
          <core-tooltip>
            <img src="{{t.thumb}}" data-digest="{{t.digest}}"/>
            <div tip large>
              <table border="0" cellspacing="5" cellpadding="5">
                <tr><th>N</th><td>{{t.n}}</td></tr>
              </table>
            </div>
          </core-tooltip>
        </template>
      </div>
      <div horizontal layout>
        <div vertical layout>
          <template repeat="{{l in value.left}}">
            <core-tooltip>
              <img src="{{l.thumb}}" data-digest="{{l.digest}}"/>
            <div tip large>
              <table border="0" cellspacing="5" cellpadding="5">
                <tr><th>N</th><td>{{l.n}}</td></tr>
              </table>
            </div>
            </core-tooltip>
          </template>
        </div>
        <div vertical layout>
          <template repeat="{{row in value.grid}}">
            <div horizontal layout>
              <template repeat="{{g in row}}">
                <core-tooltip>
                  <img src="{{g.thumb}}" data-top="{{g.topDigest}}" data-left="{{g.leftDigest}}"/>
                  <div tip large>
                    <table border="0" cellspacing="5" cellpadding="5">
                      <tr><th>Pixel Diff (%)</th><td>{{g.pixelDiffPercent}}</td></tr>
                      <tr><th>Num Diff Pixels</th><td>{{g.numDiffPixels}}</td></tr>
                      <tr><th>Max RBBA Diffs</th><td>[{{g.maxRGBADiffs}}]</td></tr>
                    </table>
                  </div>
                </core-tooltip>
              </template>
            </div>
          </template>
        </div>
      </div>
    </div>
  </template>
  <script>
    Polymer({
      ready: function() {
        this.value = {};

        var that = this;
        this.$.container.addEventListener('mouseover', this.mouseAction.bind(this));
        this.$.container.addEventListener('click', this.mouseAction.bind(this));
      },

      mouseAction: function(e) {
        // Move up the DOM until yo find the 'img' element.
        var target = e.target;
        while (target != null && target.localName != 'img') {
          target = target.parentElement;
        }
        if (target != null && target.dataset['top']) {
          // Look through the value.grid for the matching infomation.
          for (var i = 0, len = this.value.grid.length; i < len; i++) {
            var row = this.value.grid[i];
            for (var j = 0, rlen = row.length; j < rlen; j++) {
              var d = row[j];
              if (d.topDigest == target.dataset['top'] && d.leftDigest == target.dataset['left']) {
                if (e.type == "mouseover") {
                  this.dispatchEvent(new CustomEvent('diff-focus', {detail: d}));
                } else {
                  this.dispatchEvent(new CustomEvent('diff-click', {detail: d}));
                }
                break;
              }
            }
          }
        }
      },

      markChanged : function (digest) {
        $$('img', this.shadowRoot).forEach(function(ele) {
          if (ele.dataset.digest == digest
              || ele.dataset.top == digest
              || ele.dataset.left == digest
             ) {
            ele.classList.add('changed');
          }
        });
      },

      setValue: function(value) {
        this.value = value;
      }

    });
  </script>
</polymer-element>
