<!-- The <diff-detail-sk> custom element declaration.

Presents detailed information about the differences
between two images.

  Attributes:
    highlight - A serialized PolyTestDiffInfo. An object of the form:

      {
        pixelDiffPercent: 35.9,
        numDiffPixels: 11020,
        maxRGBADiffs: [60, 62, 10, 0],
      }

    value - An object of the form:

      {
        test: "testname",
        top:  "1a2b3c...", // Digest of top image.
        left: "1a2b3c...", // Digest of left image.
      }

  Events:
    triage - The change event e.detail has the form:
      {
            test: "testname1",
            digest: "aabb112233",
            status: "positive",
      }

  Methods:
    hide - Hide the whole panel.
-->
<polymer-element name="diff-detail-sk" attributes="highlight value">
  <template>
    <style type="text/css" media="screen">
      th {
        text-align: right;
      }

      th, td {
        text-align: left;
        padding: 5px;
        vertical-align: top;
      }

      tri-sk {
        min-width: 15em;
        display: block;
      }

      #diffInfo {
        display: none;
      }

      #diffInfo.display {
        display: block;
      }
      table {
        margin: auto;
      }
      .diffThumb,
      #zoom {
        display: inline-block;
      }

      #digestRow th,
      #digestRow td {
        padding-top: 2em;
      }
    </style>
    <div id=diffInfo vertical layout>
      <table border="0" cellspacing="5" cellpadding="5">
        <tr><th>Pixel Diff (%)</th><td>{{highlight.pixelDiffPercent}}</td></tr>
        <tr><th>Num Diff Pixels</th><td>{{highlight.numDiffPixels}}</td></tr>
        <tr><th>Max RBBA Diffs</th><td>{{highlight.maxRGBADiffs}}</td></tr>
        <tr><th>Diff</th><td><img id=diffThumb src="{{highlight.thumb}}"></td><td><paper-button id=zoom>Zoom</paper-button></td></tr>
      </table>
      <div id=params>
        <table>
          <tr>
            <th></th>
            <th>Left</th>
            <th>Top</th>
          </tr>
          <tr>
            <th>Status</th>
            <td><tri-sk id=leftDetail value="untriaged" title="{{value.left}}"></tri-sk> </td>
            <td><tri-sk id=topDetail value="untriaged" title="{{value.top}}"></tri-sk></td>
          </tr>
          <tr>
            <th>Image</th>
            <td><img src="/img/images/{{value.left}}-thumbnail.png"></td>
            <td><img src="/img/images/{{value.top}}-thumbnail.png"></td>
          </tr>

          <template repeat="{{p in details.params}}">
            <tr>
              <th>{{p.name}}</th>
              <td class=pval>
                <template repeat="{{n in p.left}}">
                  {{n}}
                </template>
              </td>
              <td class=pval>
                <template repeat="{{n in p.top}}">
                  {{n}}
                </template>
              </td>
            </tr>
          </template>
          <tr id=digestRow>
            <th>Digest</th>
            <td>{{value.left}}</td>
            <td>{{value.top}}</td>
          </tr>
        </table>
      </div>
    </div>
    <zoom-sk id=zoomer></zoom-sk>
  </template>
  <script>
    Polymer({
      publish: {
        highlight: {
          value: {},  // A serialized PolyTestDiffInfo.
          reflect: true,
        },
        value: {
          value: {},
          reflect: true,
        },
      },

      ready: function() {
        this.details = {}; // A serialized PolyDetailsGUI.

        var that = this;
        this.$.topDetail.addEventListener('change', function(e) {
          e.stopPropagation();
          var detail = {
            test: that.value.test,
            digest: that.value.top,
            status: e.detail,
          };
          that.dispatchEvent(new CustomEvent('triage', {detail: detail}));
        });
        this.$.leftDetail.addEventListener('change', function(e) {
          e.stopPropagation();
          var detail = {
            test: that.value.test,
            digest: that.value.left,
            status: e.detail,
          };
          that.dispatchEvent(new CustomEvent('triage', {detail: detail}));
        });
        this.$.zoom.addEventListener('click', function() {
          that.$.zoomer.setDetails(that.highlight);
          that.$.zoomer.toggle();
        });
      },

      valueChanged: function() {
        if (this.value) {
          var that = this;
          var q = '?test=' + this.value.test + '&top=' + this.value.top + '&left=' + this.value.left;
          sk.get('/2/_/details'+q).then(JSON.parse).then(function(json) {
            that.details = json;
            that.$.topDetail.value = json.topStatus;
            that.$.leftDetail.value = json.leftStatus;
            that.$.diffInfo.classList.add('display');
          });
        }
      },

      hide: function() {
        this.$.diffInfo.classList.remove('display');
      },
    });
  </script>
</polymer-element>
