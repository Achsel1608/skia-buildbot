<!-- The <test-summary-details-sk> custom element declaration.

  Displays the details about all the untriaged digests in one test summary.

  Attributes:
    test - The name of the test.
    digest - The digest we are interested in.
    limit - The maximum number of digests to display.
    triage - A boolean, if true, then display the triage controls.
    data-diff - A read-only attribute that is the size of the difference between
        this digest and the closest positive digest. Will be set before the
        'loaded' event. May be set to Infinity if there are no positive digests.
    data-closest - A read-only attribute that is the digest of the closest image.
    data-diffdigests - A read-only attribute of the digest and the closest positive
      image digest, separated by a dash, ala "abbab-12131>". The digests are in
      sorted order, so they can be used in /img/diffs/ URLs.

  Events:
    triage - A triage event is generated when the triage button is pressed. The e.detail
       of the event looks like:

       {
         digest: ["ba636123..."],
         status: "positive",
         test: "blurs"
       }

    details-loaded - A loaded event is generated the the control has finished loading data
      from the server and the data-diff attribute has been set. The test-summary-details-sk
      element is returned in e.detail.

  Methods:
    triggerTriage(status) - Set the triage status of the digest, triggering the triage event.
-->
<polymer-element name="test-summary-details-sk">
  <template>
    <style type="text/css" media="screen">
      g:hover circle {
        fill:   #44aa99;
        stroke: #44aa99;
      }
      circle.status0 {
        fill:   #000000;
        stroke: #000000;
      }
      circle.status1 {
        fill:   #ffffff;
        stroke: #1B9E77;
      }
      circle.status2 {
        fill:   #ffffff;
        stroke: #D95F02;
      }
      circle.status3 {
        fill:   #ffffff;
        stroke: #7570B3;
      }
      circle.status4 {
        fill:   #ffffff;
        stroke: #E7298A;
      }
      circle.status5 {
        fill:   #ffffff;
        stroke: #66A61E;
      }
      circle.status6 {
        fill:   #ffffff;
        stroke: #E6AB02;
      }
      circle.status7 {
        fill:   #ffffff;
        stroke: #A6761D;
      }
      circle.status8 {
        fill:   #ffffff;
        stroke: #999999;
      }
      #legend {
        margin-left: 5em;
        margin-bottom: 2em;
      }
      dots-sk {
        display: block;
      }
      .more {
        margin-left: 3em;
      }
      .preview {
        margin: 5px;
        border: solid 2px lightgray;
        display: block;
        width: 132px;
        height: 132px;
      }
      .preview img {
        display: block;
        max-width: 128px;
        max-height: 128px;
        width: auto;
        height: auto;

      }
      .hidden * {
        display: none;
      }
      .triageInfo,
      .triageInfo div {
        padding: 0.5em;
      }
      #images {
        margin-right: 1.5em;
      }
      #warning {
        font-weight: bold;
        width: 5em;
        padding: 1em;
        color: #E7298A;
      }
      #paramset th {
        text-align: right;
        padding-right: 0.5em;
      }

      #paramset span {
        margin-right: 0.2em;
      }

      #paramset .hover {
        color: #E7298A;
        font-weight: bold;
      }
    </style>
    <div horizontal layout>
      <template if="{{triage && negIsClosest}}">
        <div vertical layout id=warning>
          Closest Image Is Negative!
        </div>
      </template>
      <template if="{{triage && details.closest.digest}}">
        <div horizontal layout id=images>
          <div class=preview>
            <img src="/img/images/{{details.closest.digest}}.png" />
          </div>
          <a href="/img/images/{{details.closest.digest}}.png" target=_blank><core-icon icon="open-in-new"></core-icon></a>
          <div class=preview>
            <img src="/img/diffs/{{diffDigests}}.png" />
          </div>
          <a href="/img/diffs/{{diffDigests}}.png" target=_blank><core-icon icon="open-in-new"></core-icon></a>
          <div class=preview>
            <img src="/img/images/{{digest}}.png" />
          </div>
          <a href="/img/images/{{digest}}.png" target=_blank><core-icon icon="open-in-new"></core-icon></a>
        </div>
      </template>
      <template if="{{triage && !details.closest.digest}}">
        <div>
          <strong>No Positive Digests Found.</strong>
        </div>
      </template>
      <div vertical layout>
        <a href="/detail?test={{test}}&digest={{digest}}">{{digest}}</a>
        <dots-sk id=dots></dots-sk>
        <template if="{{isTruncated}}">
          <div class=more><a href="/detail?test={{test}}&digest={{digest}}">(more)</a></div>
        </template>
        <table id=legend>
          <template repeat="{{digestInfo, i in details.otherDigests}}">
            <tr>
              <td>
                <svg width=10 height=10 viewBox="-1 -1 2 2">
                  <circle cx=0 cy=0 r="0.3" class="status{{i+1}}"/>
                </svg>
              </td>
              <td>
                <template if="{{i<7}}">
                  <code><a href="/detail?test={{test}}&digest={{digestInfo.digest}}">{{digestInfo.digest}}</a></code>
                </template>
                <template if="{{i==7}}">
                  One of many other digests.
                </template>
              </td>
              <td>
                <template if="{{i<7}}">
                  <tricon-sk value="{{digestInfo.status}}"></tricon-sk>
                </template>
              </td>
              <td>
                <template if="{{i<7}}">
                  <a href="/diff?test={{test}}&left={{digestInfo.digest}}&top={{digest}}">diff</a>
                </template>
              </td>
            </tr>
          </template>
        </table>
      </div>
      <div vertical layout id=paramset>
        <table>
          <template repeat="{{p in details.params}}">
            <tr>
              <th>{{p.name}}</th>
              <td>
                <template repeat="{{v in p.top}}">
                  <span id="param_{{p.name}}_{{v | asId}}">{{v}}</span>
                </template>
              </td>
            </tr>
          </template>
        </table>
      </div>
      <div vertical layout class="{{triage ? 'triageInfo' : 'hidden'}}">
        <div><a href="/diff?test={{test}}&left={{digest}}&top={{details.closest.digest}}">Details</a></div>
        <div>Diff: {{details.closest.diff | fixedPercent }}%</div>
        <div>Max RGBA: [{{details.closest.maxRGBA}}]</div>
        <tri-sk data-digest="{{digest}}" data-test="{{test}}" value=untriaged id=triage></tri-sk>
      </div>
    </div>
  </template>
  <script>
    Polymer({
      publish: {
        test: {
          value: "",
          reflect: true,
        },
        digest: {
          value: "",
          reflect: true,
        },
        limit: {
          value: 0,
          reflect: true,
        },
        triage: {
          value: false,
          reflect: true,
        },
      },

      ready: function() {
        this.details = {};
        this.isTruncated = false;
        this.negIsClosest = false;
        this.diffDigests = "";
        var that = this;
        this.$.triage.addEventListener('change', function(e) {
          // Convert the change event from the triage button into a more detailed triage event.
          var detail = {
            "test": e.target.dataset.test,
            "digest": [e.target.dataset.digest],
            "status": e.target.value,
          };
          that.dispatchEvent(new CustomEvent('triage', {detail: detail, bubbles: true}));
        });

        this.$.dots.addEventListener('hover', function(e) {
          var id = e.detail;
          var params = {};
          // Find the matching trace in details.traces.
          for (var i=0; i<that.details.traces.length; i++) {
            if (that.details.traces[i].label == id) {
              params = that.details.traces[i].params;
              break;
            }
          }
          that.clearParamHighlights();
          Object.keys(params).forEach(function(k) {
            $$$('#param_'+k+'_'+that.asId(params[k]), that.$.paramset).classList.add('hover');
          });
        });

        this.$.dots.addEventListener('mouseleave', function() {
          that.clearParamHighlights();
        });
      },

      // Remove the hover class from all of the paramset values.
      clearParamHighlights: function() {
        $$('[class=hover]', this.$.paramset).forEach(function(ele) {
          ele.classList.remove('hover');
        });
      },

      // asId strips out non-alphanum characters, which makes them into
      // strings that can be easily used by querySelector as an id.
      asId: function(s) {
        return s.replace(/[^a-zA-Z0-9]/gi, '');
      },

      triggerTriage: function(status) {
        this.$.triage.value = status;
        var detail = {
          "test": this.$.triage.dataset.test,
          "digest": [this.$.triage.dataset.digest],
          "status": status,
        };
        this.dispatchEvent(new CustomEvent('triage', {detail: detail, bubbles: true}));
      },

      reloadData: function() {
        if (this.test == "" || this.digest == "") {
          return
        }

        var that = this;
        var q = '?test=' + this.test + '&top=' + this.digest+ '&left=' + this.digest + '&graphs=true&closest=' + this.triage;
        sk.get('_/details'+q).then(JSON.parse).then(function(json) {
          if (that.limit && that.limit < json.traces.length) {
            json.traces = json.traces.slice(0, that.limit);
            that.isTruncated = true;
          }
          if (that.triage) {
            json.closest = json.posClosest.diff < json.negClosest.diff ? json.posClosest : json.negClosest;
            that.negIsClosest = json.negClosest.diff < json.posClosest.diff;
          }
          that.details = json;
          that.$.dots.setValue(that.details);
          that.$.dots.setCommits(that.details.commits);

          if (that.triage) {
            if (json.closest.digest != "") {
              that.dataset.diff = json.closest.diff;
              that.dataset.closest = json.closest.digest;
              if (json.closest.digest < that.digest) {
                that.diffDigests = json.closest.digest + "-" + that.digest;
              } else {
                that.diffDigests = that.digest + "-" + json.closest.digest;
              }
              that.dataset.diffdigests = that.diffDigests;
            } else {
              that.dataset.diff = Infinity;
            }
          }
          that.dispatchEvent(new CustomEvent('details-loaded', {detail: that, bubbles: true}));
        });
      },

      testChanged: function() {
        this.reloadData();
      },

      digestChanged: function() {
        this.reloadData();
      },

      limitChanged: function() {
        if (this.details.traces && this.limit < this.details.traces.length) {
          this.details.traces = this.details.traces.slice(0, this.limit);
          this.$.dots.setValue(this.details);
          this.isTruncated = true;
        } else {
          this.reloadData();
        }
      },

      fixedPercent: function(i) {
        if (i) {
          return i.toFixed(2);
        } else {
          return '';
        }
      },
    });
  </script>
</polymer-element>
