<!-- The <test-summary-sk> custom element declaration.

  Displays a summary for the given test.

  Attributes:
    summary - A object that gives a summary of a test. Should look like:

         {
           "name": "01-original",
           "diameter": 123242,
           "untriaged": 2,
           "num": 2,
           "untHashes": ["ababab...", "2b2b2b2...", ...],
         }

    query - paramset in URL query string format.
    include - boolean, include ignores.
    head - boolean, only use digests at head.
    details - boolean, if true display the details about the untriaged digests.
    limit - The maximum number of traces and digests to show when displaying details.
    triage - If true display the image, its closest match, and the triage controls.

  Events:
  Methods:
-->
<polymer-element name="test-summary-sk">
  <template>
    <style type="text/css" media="screen">
      span {
        width: 25em;
        display: inline-block;
        overflow-wrap: break-word;
        margin-left: 1em;
      }
      span.short {
        width: 5em;
      }
      .detail {
        margin-left: 3em;
        padding: 0.5em;
      }
      test-summary-details-sk {
        box-shadow: 3px 3px 6px 1px rgba(133,133,133,1);
        margin-top: 1em;
        margin-bottom: 1em;
        margin-left: 3em;
        padding: 1em;
      }
      test-summary-details-sk[data-focus] {
        box-shadow: 3px 3px 6px 5px #FF7F00;
      }
      test-summary-details-sk[triage] {
        display: none;
      }
      test-summary-details-sk[triage][data-diff] {
        display: block;
      }
      .only {
        margin-left: 3em;
        font-weight: bold;
        padding: 1em;
      }
    </style>
    <div vertical layout>
      <div horizontal layout>
        <span><b> <a href="/#/triage/{{summary.name}}?head={{head}}">{{summary.name}}</a> </b></span>
        <!-- <span class=short>{{summary.diameter}}</span> -->
        <span class=short>
          <a href="/2/cmp/{{summary.name}}?topQuery={{query}}&topIncludeIgnores={{include}}&leftQuery={{query}}&leftIncludeIgnores={{include}}&head={{head}}">
            <core-icon icon=apps></core-icon>
          </a>
        </span>
        <span class=short>{{summary.pos}}</span>
        <span class=short>{{summary.neg}}</span>
        <span class=short>{{summary.untriaged}}</span>
        <span class=short>{{summary.num}}</span>
        <span class=short>
          <template if="{{!triage}}">
            <!-- TODO(jcgregorio) Strip out all other test names from query. -->
            <a href="/2/?query={{query}}%26name%3D{{summary.name}}&include={{include}}&head={{head}}&untonly=false&details=true&limit=500&triage=true">
              Triage
            </a>
          </template>
        </span>
      </div>
      <div vertical layout id=details>
        <template if="{{details}}">
          <template repeat="{{d, i in summary.untHashes}}">
            <template if="{{i<limit}}">
              <test-summary-details-sk test="{{summary.name}}" digest="{{d}}" limit="{{limit}}" triage="{{triage}}"></test-summary-details-sk>
            </template>
          </template>
          <template if="{{summary.untHashes.length>limit}}">
            <div class=only>Only the first {{limit}} hashes are shown.</only>
          </template>
        </template>
      </div>
      <paper-spinner id=spinner></paper-spinner>
      <paper-dialog id=help heading="Keyboard Shortcuts">
        <table>
          <tr><th>J</th><td>Next</td></tr>
          <tr><th>K</th><td>Prev</td></tr>
          <tr><th></th><td></td></tr>
          <tr><th>A</th><td>Postive</td></tr>
          <tr><th>S</th><td>Negative</td></tr>
          <tr><th>D</th><td>Untriaged</td></tr>
        </table>
      </paper-dialog>
    </div>
  </template>
  <script>
    Polymer({
      publish: {
        summary: {
          value: {},
          reflect: true,
        },
        query: {
          value: "",
          reflect: true,
        },
        include: {
          value: false,
          reflect: true,
        },
        head: {
          value: true,
          reflect: true,
        },
        limit: {
          value: 0,
          reflect: true,
        },
        details: {
          value: false,
          reflect: true,
        },
        triage: {
          value: false,
          reflect: true,
        },
      },

      created: function() {
        this.summary = {};
      },

      ready: function() {
        this.loadedCount = 0;
        var that = this;
        // Listen for each test-summary-details-sk to complete loading.
        this.$.details.addEventListener('details-loaded', function(e) {
          // Move the newly loaded element to the right location in the list.
          var node = e.detail;
          var last = null;
          var diffValue = +node.dataset.diff;
          // Find the sibling element we should appear before, which is the
          // first element with a smaller diff value.
          $$('test-summary-details-sk', that.$.details).forEach(function(ele) {
            var d = ele.dataset.diff;
            if (d) {
              if (last == undefined && +d < diffValue) {
                last = ele;
              }
            }
          });
          // Insert the node, in the list, or as the first child if last=null.
          that.$.details.insertBefore(node, last);

          // Keep the spinner spinning until all details elements have been loaded.
          that.loadedCount++;
          if (that.loadedCount == that.summary.untHashes.length) {
            that.$.spinner.active = false;
          }
        });
        this.enableKeyboardShortcuts();
      },

      // findFocus returns the current details element with the keyboard focus.
      findFocus: function() {
        return $$$('test-summary-details-sk[data-focus]', this.shadowRoot)
      },

      // moveFocus does the actual work of changing the focus from lastEle
      // to nextEle.
      moveFocus: function(lastEle, nextEle) {
        // Don't wrap around past the bottom of the list.
        if (lastEle != null && nextEle == null) {
          return
        }
        if (lastEle != null) {
          lastEle.removeAttribute('data-focus');
        }
        // If nothing is selected, then focus on the first details element.
        if (nextEle == null) {
          nextEle = $$$('test-summary-details-sk', this.shadowRoot);
        }
        nextEle.setAttribute('data-focus', 'true');
        nextEle.scrollIntoView(false);
      },

      // Move the focus to the next digest.
      focusNext: function() {
        var nextEle = null;
        var lastEle = this.findFocus();
        if (lastEle != null) {
          nextEle = lastEle.nextElementSibling;
        }
        this.moveFocus(lastEle, nextEle);
      },

      // Move the focus to the previous digest.
      focusPrev: function() {
        var nextEle = null;
        var lastEle = this.findFocus();
        if (lastEle != null) {
          nextEle = lastEle.previousElementSibling;
          if (nextEle.nodeName == "TEMPLATE") {
            nextEle = null;
          }
        }
        this.moveFocus(lastEle, nextEle);
      },

      // Set the triage status of the digest with focus to 'status'.
      markFocus: function(status) {
        if (!this.triage) {
          return
        }
        var focus = this.findFocus();
        if (focus != null) {
          focus.triggerTriage(status);
        }
      },

      enableKeyboardShortcuts: function() {
        var that = this;
        // Allow keyboard navigation for fast triaging.
        document.body.addEventListener('keydown', function(e){
          var c = String.fromCharCode(e.keyCode);
          switch (c) {
            case "J":
              that.focusNext();
              break;
            case "K":
              that.focusPrev();
              break;
            case "A":
              that.markFocus("positive");
              break;
            case "S":
              that.markFocus("negative");
              break;
            case "D":
              that.markFocus("untriaged");
              break;
            case "Â¿":
              that.$.help.open();
              break;
          }
        });
      },

      summaryChanged: function() {
        this.dataset.name = this.summary.name;
        this.dataset.diameter = this.summary.diameter;
        this.dataset.pos = this.summary.pos;
        this.dataset.neg = this.summary.neg;
        this.dataset.untriaged = this.summary.untriaged;
        this.dataset.num  = this.summary.num;
        this.loadedCount = 0;
        if (this.triage && this.details) {
          this.$.spinner.active = true;
        }
      },

    });
  </script>
</polymer-element>
