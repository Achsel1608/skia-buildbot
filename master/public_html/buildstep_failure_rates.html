<html>
  <head>
  <title>Skia Buildstep Failure Rates</title>
  <link rel="icon" href="favicon.ico">
  <script language="JavaScript">
  "use strict";

  var buildStepFailureRates = null;
  var loadStart = null;

  /**
   * Display text or HTML in the logging div.
   * @param {string} msg The HTML or text to display.
   */
  function setMessage(msg) {
    console.log(msg);
    document.getElementById("logging_div").innerHTML = msg;
  }

  function loadJSONP(url, callbackName) {
    var script = document.createElement("script");
    var join = "&";
    if (url.indexOf("?") < 0) {
      join = "?";
    }
    script.src = url + join + "jsonp=" + callbackName;
    document.head.appendChild(script);
  }

  function gotGraphiteData(data) {
    var buildStepData = {};
    for (var i = 0; i < data.length; ++i) {
      var splitName = data[i]["target"].split(".");
      var stepName = splitName[0];
      var resultType = splitName[1];
      var datapoints = data[i]["datapoints"];
      var resultCount = 0;
      if (datapoints.length > 0) {
        resultCount = datapoints[datapoints.length - 1][0];
      }
      if (resultCount == null) {
        resultCount = 0;
      }
      if (!buildStepData[stepName]) {
        buildStepData[stepName] = {};
      }
      buildStepData[stepName][resultType] = resultCount;
    }
    buildStepFailureRates = [];
    for (var stepName in buildStepData) {
      var success = parseFloat(buildStepData[stepName]["success"]);
      var failure = parseFloat(buildStepData[stepName]["failure"]);
      var totalRuns = success + failure;
      var failureRate = failure / (success + failure);
      if (totalRuns <= 0) {
        failureRate = 0;
      }
      buildStepFailureRates.push([stepName, failureRate, totalRuns]);
    }
    buildStepFailureRates.sort(function(a, b) {
      return b[1] - a[1];
    });
    var table = document.createElement("table");
    var thead = document.createElement("thead");
    var headerStepName = document.createElement("td");
    headerStepName.innerHTML = "Step";
    thead.appendChild(headerStepName);
    var headerFailRate = document.createElement("td");
    headerFailRate.innerHTML = "Failure Rate";
    thead.appendChild(headerFailRate);
    var headerTotalRuns = document.createElement("td");
    headerTotalRuns.innerHTML = "Total Runs";
    thead.appendChild(headerTotalRuns);
    table.appendChild(thead);
    for (var i = 0; i < buildStepFailureRates.length; ++i) {
      var tr = document.createElement("tr");
      var tdStepName = document.createElement("td");
      tdStepName.innerHTML = buildStepFailureRates[i][0];
      tr.appendChild(tdStepName);
      var tdFailRate = document.createElement("td");
      tdFailRate.innerHTML = buildStepFailureRates[i][1];
      tr.appendChild(tdFailRate);
      var tdTotalRuns = document.createElement("td");
      tdTotalRuns.innerHTML = buildStepFailureRates[i][2];
      tr.appendChild(tdTotalRuns);
      table.appendChild(tr);
    }
    var displayDiv = document.getElementById("display_div");
    displayDiv.innerHTML = "";
    displayDiv.appendChild(table);
    displayDiv.style.display = "block";
    var message = "";
    if (loadStart) {
      var elapsedSeconds = (new Date().getTime() - loadStart) / 1000;
      message = "Loaded data in " + elapsedSeconds + " seconds.";
    }
    setMessage(message);
  }

  /**
   * Load data from Graphite.
   */
  function loadGraphiteData() {
    setMessage("Loading...");
    document.getElementById("display_div").style.display = "none";
    loadStart = new Date().getTime();

    var timePeriod = document.getElementById("time_period").value;
    var url = "http://skiamonitor.com/render?format=json";
    var sumPrefix = "&target=aliasSub(aliasByNode(summarize(groupByNode(buildbot.*.*.*.";
    var sumMid = ",3,%22sumSeries%22),%22" + timePeriod + "%22,true),0),%22$%22,%22.";
    var sumSuffix = "%22)";
    var success = sumPrefix + "success" + sumMid + "success" + sumSuffix;
    var failure = sumPrefix + "failure" + sumMid + "failure" + sumSuffix;
    url += success + failure;
    loadJSONP(url, "gotGraphiteData");
  }

  /**
   * Callback function to use on page load. This causes the high-level builder
   * data to be loaded and the builder menu populated.
   */
  function init() {
    loadGraphiteData();
  }
  </script>
  </head>
  <body>
    <div id="heading" style="font-size:2.5em; text-align:center; height:7%;">
      Skia Buildbots Buildstep Failure Rates
    </div>
    <div id="main_content_area" style="width:100%; height:90%; padding:0px; margin:0px;">
      <div id="builder_menu_div" style="float:left; width:18%; height:100%; padding:0px; margin:0px;">
        <div style="width:100%;">
          <div>
            <nobr>Time period:</nobr><br/>
            <input type="text" id="time_period" value="24h" />
          </div>
        </div>
        <div>
          <input type="button" onClick="loadGraphiteData()"
              value="Reload Data"/>
        </div>
      </div>
      <div id="charts_div" style="float:left; width:67%; padding:0px; margin:0px">
        <div id="logging_div" style="width:100%; padding:0px; margin:0px"></div>
        <div id="display_div" style="width:100%; padding:0px; margin:0px">
          <div id="controls">Sort by: </div>
          <div id="table"></div
        </div>
      </div>
    </div>
    <script language="JavaScript">
    init();
    </script>
  </body>
</html>

