# General
ALERT InstanceDown
  IF up == 0
  FOR 5m
  LABELS { category = "infra", severity = "critical" }
  ANNOTATIONS {
    summary = "Instance {{ $labels.instance }} down",
    description = "{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 5 minutes.",
  }

ALERT TooManyGoRoutines
  IF go_goroutines > 3000
  FOR 2m
  LABELS { category = "infra", severity = "warning"}
  ANNOTATIONS {
    summary = "Too many Go routines in {{ $labels.job }}",
    description = "Too many Go routines in {{ $labels.job }} running on {{ $labels.instance }}."
  }

ALERT ProbeFailure
  IF prober{type="failure"} > 0
  FOR 5m
  LABELS { category = "infra", severity = "critical" }
  ANNOTATIONS {
    summary = "Probe failed {{ $labels.probename }}",
    description = "Endpoint {{ $labels.probename }} has failed to respond in at least 5 minutes. See https://github.com/google/skia-buildbot/search?q={{ $labels.probename }}+filename%3Aprobers.json for the endpoint URL."
  }

ALERT RebootRequired
  IF reboot_required_i > 0
  FOR 5m
  LABELS { category = "infra", severity = "warning" }
  ANNOTATIONS {
    description = "Instance {{ $label.host }} needs rebooting. Owner(s): {{ $label.owners }}. See https://mon.skia.org/dashboard/db/reboots-required for the full list of instances that need rebooting.",
  }

ALERT DiskSpaceLow
  IF df_complex_free{resource="df-boot",host!~".*rpi-.+"} < 1e9
  FOR 5m
  LABELS { category = "infra", severity = "warning" }
  ANNOTATIONS {
    description = "Low Root Disk Space on {{ $label.host }}.",
  }

ALERT DiskSpaceLow
  IF df_complex_free{resource="df-mnt-pd0|df-mnt-dds0"} < 1e10
  FOR 5m
  LABELS { category = "infra", severity = "warning" }
  ANNOTATIONS {
    description = "Low Disk Space on {{ $label.host }} on disk {{ $label.resource }}.",
  }

# Perf
ALERT PerfUntriagedClusters
  IF perf_clustering_untriaged{instance="skia-perf:20000"} > 0
  FOR 2m
  LABELS { category = "general", severity = "warning" }
  ANNOTATIONS {
    summary = "One or more untriaged clusters.",
    description = "At least one untriaged perf cluster has been found. Please visit https://perf.skia.org/t/ to triage."
  }

ALERT AndroidPerfUntriagedClusters
  IF perf_clustering_untriaged{instance="skia-android-perf:20000"} > 0
  FOR 2m
  LABELS { category = "general", severity = "warning", specialroute = "android" }
  ANNOTATIONS {
    summary = "One or more untriaged clusters.",
    description = "At least one untriaged perf cluster has been found. Please visit https://android-perf.skia.org/t/ to triage."
  }

ALERT AndroidIngestFailures
  IF rate(process_failures[2m]) > 0.1
  FOR 2m
  LABELS { category = "infra", severity = "critical" }
  ANNOTATIONS {
    description = "Error rate for processing buildids is too high. See https://github.com/google/skia-buildbot/blob/master/android_ingest/PROD.md#process_failures."
  }

ALERT PerfIngestErrorTooHigh
  IF rate(ingestion{metric="errors"}[5m]) > 1
  FOR 2m
  LABELS { category = "infra", severity = "critical" }
  ANNOTATIONS {
    description = "Perf ingestion error rate too high. See https://prom.skia.org/graph?g0.range_input=1h&g0.expr=rate(ingestion%7Bmetric%3D%22errors%22%7D%5B5m%5D)&g0.tab=0"
  }

# For fiddle, debugger, and imageinfo.

ALERT BuildsFailed
  IF builds_failed >= 2
  FOR 5m
  LABELS { category = "infra", severity = "warning" }
  ANNOTATIONS {
    description = "Build for {{ $labels.job }} has failed for the last 2 chrome DEPS rolls. https://skia.googlesource.com/buildbot/+/master/{{ $labels.job }}/PROD.md#build_fail"
  }

ALERT SyncFailed
  IF repo_sync_failed >= 2
  FOR 5m
  LABELS { category = "infra", severity = "warning" }
  ANNOTATIONS {
    description = "Sync for {{ $labels.job }} has failed 2 times in a row. https://skia.googlesource.com/buildbot/+/master/{{ $labels.job }}/PROD.md#sync_fail"
  }

ALERT NamedFiddles
  IF named_failures > 0
  FOR 5m
  LABELS { category = "infra", severity = "warning" }
  ANNOTATIONS {
    description = "See https://fiddle.skia.org/f/ and https://skia.googlesource.com/buildbot/+/master/fiddle/PROD.md#named_fail"
  }
