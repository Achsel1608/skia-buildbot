<!--
  The fuzzer/res/fuzzer.js file must be included before this file.

  This in an HTML Import-able file that contains the definition
  of the following elements:

    <fuzzer-collapse-file-sk>

  This element will poll /json/list

  To use this file import it:

    <link href="/res/imp/fuzzer-collapse-file-sk.html" rel="import" />

  Usage:

    <fuzzer-collapse-file-sk></fuzzer-collapse-file-sk>

  Properties:
    file - The FileDetails object.  Expected to have the following attributes:
      fileName: String,
      count: Number,
      byFunction: Array of FunctionDetail objects.  See fuzzer-collapse-function-sk.html for schema.

    expand: String, which should be "true" if the element and any children should start expanded.
    exclude: Array of String, all fuzzes that have one or more of these strings as a flag will not
        be shown.  This array must be sorted lexographically.
    include: Array of String, all fuzzes must have one or more of these strings as a flag to be
        shown.  This array must be sorted lexographically.

  Methods:
    setFile(file) - Programmatically set the FileDetails object.
    toggleLineNumbers() - Programmtically expand/collapse the function details.

  Events:
    None.
-->
<link rel="import" href="/res/common/imp/9/details-summary.html">
<link rel="import" href="/res/imp/bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="/res/imp/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="fuzzer-collapse-function-sk.html" />
<dom-module id="fuzzer-collapse-file-sk">
  <template>
    <style>
    #file {
      padding: 20px;
      margin: 10px;
      border-radius: 10px;
      background-color: #F5F5F5;
      color: #000000;
      display:block;
    }

    .func {
      padding: 20px;
      border-radius: 10px;
      background-color: #E5E5E5;
      color: #000000;
      display:block;
    }

    h3 {
      display:inline;
      margin-top: 0px;
    }

    ul {
      list-style-type: none;
    }
    </style>
    <details-sk id="file" open="[[expand]]">
      <summary-sk>
      <h3>
        <a href$="{{_getDetailsLink(category, file)}}">{{file.fileName}}</a>
        -- {{file.count}} crash-causing fuzzes
      </h3>
      </summary-sk>
      <template  is="dom-repeat" items="{{file.byFunction}}" as="func" sort="_byCount" observe="count">
        <fuzzer-collapse-function-sk
          class="func-group"
          expand="[[expand]]"
          func="{{func}}"
          exclude="[[exclude]]"
          include="[[include]]"
          details-base="{{_getDetailsLink(category, file)}}"
          on-dom-change="_recount"
        ></fuzzer-collapse-function-sk>
      </template>
    </details-sk>
  </template>
  <script>
  Polymer({
    is: 'fuzzer-collapse-file-sk',

    properties: {
      file: { //expected to be provided
        type: Object,
        value: function() {
          return {};
        },
      },
      category: {
        type: String,
        value: "",
      },
      // We can use one-way [[]] bindings to initialize all of the details-sk,
      // but keep their open states untangled.
      expand: {
        type: Boolean,
        value: false,
      },
      exclude: {
        type: Array,
        value: function() {
          return [];
        },
      },
      include: {
        type: Array,
        value: function() {
          return [];
        },
      },
    },

    _recount: function() {
      this.debounce("recount-file", function(){
        this.flushDebouncer("recount-function");
        var funcs = $$(".func-group", this.$.file);
        var sum = 0;
        funcs.forEach(function(a){
          sum += a.numReports;
        });
        this.set("file.count", sum);
      }.bind(this), 10);

    },

    setFile: function(file) {
      this.file = file;
    },

    _getDetailsLink: function(category, file, func) {
      if (!file) {
        return "#";
      }
      var base = fuzzer.getLinkToDetails("/category/"+category, "file", file.fileName);
      if (func) {
        base = fuzzer.getLinkToDetails(base, "func", func.functionName);
      }
      return base;
    },
    _byCount: function(a, b) {
        // Higher counts come first
        return b.count - a.count;
      }
  });
  </script>
</dom-module>
