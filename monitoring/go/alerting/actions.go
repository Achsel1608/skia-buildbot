package alerting

import (
	"fmt"
	"strings"

	"github.com/golang/glog"
	"skia.googlesource.com/buildbot.git/go/email"
)

const (
	EMAIL_FOOTER = `<br/><br/>
This email was generated by the Skia alert server.
To snooze or dismiss this alert, visit http://skiamonitor.com:8001
`
)

func sendEmail(a *Alert, to []string, emailAuth *email.GMail) {
	subject := fmt.Sprintf("Skia Alert: %s triggered at %s", a.Name, a.Triggered().String())
	body := a.Message + EMAIL_FOOTER
	err := emailAuth.Send(to, subject, body)
	if err != nil {
		glog.Errorf("Failed to send email: %s", err)
	}
}

func printAlert(a *Alert) {
	glog.Infof("ALERT: %s", a.Name)
}

func parseEmailAlert(str string, emailAuth *email.GMail) (func(*Alert), error) {
	split := strings.Split(str, ",")
	emails := []string{}
	for _, email := range split {
		emails = append(emails, strings.Trim(email, " "))
	}
	return func(a *Alert) {
		sendEmail(a, emails, emailAuth)
	}, nil
}

func parseActions(actionsInterface interface{}, emailAuth *email.GMail, testing bool) ([]func(*Alert), error) {
	actionsList := []func(*Alert){printAlert}
	actionStrings := actionsInterface.([]interface{})
	for _, a := range actionStrings {
		str := a.(string)
		if testing {
			// Do nothing; print is added by default.
		} else if strings.HasPrefix(str, "Email(") && strings.HasSuffix(str, ")") {
			f, err := parseEmailAlert(str[6:len(str)-1], emailAuth)
			if err != nil {
				return nil, err
			}
			actionsList = append(actionsList, f)
		} else if str == "Print" {
			// Do nothing; print is added by default.
		} else {
			return nil, fmt.Errorf("Unknown action: %q", str)
		}
	}
	return actionsList, nil
}
